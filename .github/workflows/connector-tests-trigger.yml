name: Connector Tests Trigger
on:
  workflow_run:
    workflows: ["Python Build", "Metadata Ingestion"]
    types: [completed]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.workflow_run.name }}-${{ github.event.workflow_run.head_branch }}
  cancel-in-progress: true

jobs:
  publish-cloudflare:
    runs-on: ubuntu-latest
    # Only publish when triggered by Python Build success (NOT Metadata Ingestion)
    # This ensures Cloudflare publish happens regardless of MI status
    if: >-
      github.event.workflow_run.name == 'Python Build' &&
      github.event.workflow_run.conclusion == 'success' &&
      vars.CLOUDFLARE_WHEELS_PROJECT_NAME != ''
    permissions:
      contents: read
      deployments: write
      actions: read
    outputs:
      pypi_index_url: ${{ steps.cloudflare.outputs.url }}
      pypi_index_simple_url: ${{ steps.set-pypi-url.outputs.pypi_index_simple_url }}
    steps:
      - name: Log trigger context
        run: |
          echo "::group::Trigger Context"
          echo "Triggered by: ${{ github.event.workflow_run.name }}"
          echo "Conclusion: ${{ github.event.workflow_run.conclusion }}"
          echo "SHA: ${{ github.event.workflow_run.head_sha }}"
          echo "Branch: ${{ github.event.workflow_run.head_branch }}"
          echo "Source repo: ${{ github.event.workflow_run.head_repository.full_name }}"
          echo "Run ID: ${{ github.event.workflow_run.id }}"
          echo "Run URL: ${{ github.event.workflow_run.html_url }}"
          echo "Cloudflare project: ${{ vars.CLOUDFLARE_WHEELS_PROJECT_NAME }}"
          echo "::endgroup::"

      - name: Download wheel site artifact from Python Build
        uses: actions/download-artifact@v4
        with:
          name: datahub-wheel-site
          path: site
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}

      - name: Log downloaded artifact
        run: |
          echo "::group::Downloaded Artifact"
          ls -lh site/ 2>/dev/null | head -20 || echo "No files found"
          echo "Total size: $(du -sh site/ 2>/dev/null | cut -f1 || echo 'N/A')"
          echo "::endgroup::"

      - name: Publish to Cloudflare Pages
        id: cloudflare
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: ${{ vars.CLOUDFLARE_WHEELS_PROJECT_NAME }}
          directory: site
          gitHubToken: ${{ github.token }}

      - name: Set PyPI index URL output
        id: set-pypi-url
        run: |
          PYPI_URL="${{ steps.cloudflare.outputs.url }}/simple"
          echo "pypi_index_simple_url=$PYPI_URL" >> "$GITHUB_OUTPUT"
          echo "PyPI index URL: $PYPI_URL"

  dispatch-connector-tests:
    runs-on: ubuntu-latest
    needs: [publish-cloudflare]
    # Run even when publish-cloudflare was skipped (MI trigger), but not when it failed
    if: >-
      always() &&
      github.event.workflow_run.conclusion == 'success' &&
      needs.publish-cloudflare.result != 'failure'
    permissions:
      actions: read
      statuses: write
    steps:
      - name: Log trigger context
        run: |
          echo "::group::Trigger Context (dispatch job)"
          echo "Triggered by: ${{ github.event.workflow_run.name }}"
          echo "Conclusion: ${{ github.event.workflow_run.conclusion }}"
          echo "SHA: ${{ github.event.workflow_run.head_sha }}"
          echo "Branch: ${{ github.event.workflow_run.head_branch }}"
          echo "Source repo: ${{ github.event.workflow_run.head_repository.full_name }}"
          echo "publish-cloudflare result: ${{ needs.publish-cloudflare.result }}"
          echo "publish-cloudflare pypi_index_url: ${{ needs.publish-cloudflare.outputs.pypi_index_url }}"
          echo "publish-cloudflare pypi_index_simple_url: ${{ needs.publish-cloudflare.outputs.pypi_index_simple_url }}"
          echo "::endgroup::"

      - name: Check BOTH workflows passed for this SHA
        id: check-both
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          SHA="${{ github.event.workflow_run.head_sha }}"
          REPO="${{ github.repository }}"

          # Check Python Build status
          WB=$(gh api "/repos/${REPO}/actions/workflows/python-build-pages.yml/runs?head_sha=${SHA}&per_page=1" \
            --jq '.workflow_runs[0].conclusion // empty')

          # Check Metadata Ingestion status
          MI=$(gh api "/repos/${REPO}/actions/workflows/metadata-ingestion.yml/runs?head_sha=${SHA}&per_page=1" \
            --jq '.workflow_runs[0].conclusion // empty')

          echo "Python Build: $WB"
          echo "Metadata Ingestion: $MI"

          if [ "$WB" = "success" ] && [ "$MI" = "success" ]; then
            echo "both_passed=true" >> "$GITHUB_OUTPUT"
          else
            echo "Not both workflows passed yet (WB=$WB, MI=$MI)"
            echo "The other trigger will handle it when it fires."
            echo "both_passed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Verify Cloudflare deployment exists for this SHA
        if: steps.check-both.outputs.both_passed == 'true'
        id: verify-cloudflare
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # If publish-cloudflare ran in THIS run (Python Build trigger), it's guaranteed
          URL="${{ needs.publish-cloudflare.outputs.pypi_index_simple_url }}"
          if [ -n "$URL" ]; then
            echo "source=job_output" >> "$GITHUB_OUTPUT"
            echo "url=$URL" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Triggered by MI — check that a previous W2 run published to Cloudflare
          SHA="${{ github.event.workflow_run.head_sha }}"
          REPO="${{ github.repository }}"

          DEPLOY_ID=$(gh api "/repos/${REPO}/deployments?sha=${SHA}&per_page=10" \
            --jq '[.[] | select(.environment | test("wheels"; "i"))][0].id // empty')

          if [ -z "$DEPLOY_ID" ]; then
            echo "::error::No Cloudflare deployment found for SHA ${SHA}. The Cloudflare publish (triggered by Python Build) may have failed. Re-run the Python Build workflow to retry."
            exit 1
          fi

          DEPLOY_URL=$(gh api "/repos/${REPO}/deployments/${DEPLOY_ID}/statuses" \
            --jq '.[0].environment_url // empty')

          if [ -z "$DEPLOY_URL" ]; then
            echo "::error::Cloudflare deployment ${DEPLOY_ID} exists but has no URL. The publish may have failed mid-deploy. Re-run the Python Build workflow to retry."
            exit 1
          fi

          echo "source=deployments_api" >> "$GITHUB_OUTPUT"
          echo "url=${DEPLOY_URL}/simple" >> "$GITHUB_OUTPUT"
          echo "Cloudflare URL from deployments API: ${DEPLOY_URL}/simple"

      - name: Get PR info
        if: steps.check-both.outputs.both_passed == 'true'
        id: pr-info
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          SHA="${{ github.event.workflow_run.head_sha }}"
          REPO="${{ github.repository }}"
          BRANCH="${{ github.event.workflow_run.head_branch }}"
          HEAD_REPO="${{ github.event.workflow_run.head_repository.full_name }}"

          PR_NUMBER=$(gh api "/repos/${REPO}/pulls?head=${HEAD_REPO}:${BRANCH}&state=open" \
            --jq '.[0].number // empty')

          if [ -z "$PR_NUMBER" ]; then
            echo "No open PR found for branch ${BRANCH} — skipping dispatch"
            echo "has_pr=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "has_pr=true" >> "$GITHUB_OUTPUT"
          echo "pr_number=$PR_NUMBER" >> "$GITHUB_OUTPUT"
          echo "sha=$SHA" >> "$GITHUB_OUTPUT"

          # Classify author as internal or community
          AUTHOR_ASSOC=$(gh api "/repos/${REPO}/pulls/${PR_NUMBER}" --jq '.author_association')

          if [ "$AUTHOR_ASSOC" = "MEMBER" ] || [ "$AUTHOR_ASSOC" = "OWNER" ] || [ "$AUTHOR_ASSOC" = "COLLABORATOR" ]; then
            echo "author_type=internal" >> "$GITHUB_OUTPUT"
          else
            echo "author_type=community" >> "$GITHUB_OUTPUT"
          fi

          PR_AUTHOR=$(gh api "/repos/${REPO}/pulls/${PR_NUMBER}" --jq '.user.login')
          echo "PR #${PR_NUMBER} by ${PR_AUTHOR} (${AUTHOR_ASSOC})"

      - name: Set pending commit status
        if: steps.check-both.outputs.both_passed == 'true' && steps.pr-info.outputs.has_pr == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api "/repos/${{ github.repository }}/statuses/${{ steps.pr-info.outputs.sha }}" \
            -f state=pending \
            -f context="connector-tests" \
            -f description="Connector tests triggered, waiting for results..."

      - name: Fire repository_dispatch to connector-tests
        if: steps.check-both.outputs.both_passed == 'true' && steps.pr-info.outputs.has_pr == 'true'
        env:
          GH_TOKEN: ${{ secrets.CONNECTOR_TESTS_DISPATCH_TOKEN }}
        run: |
          PAYLOAD=$(jq -nc \
            --arg pr "${{ steps.pr-info.outputs.pr_number }}" \
            --arg sha "${{ steps.pr-info.outputs.sha }}" \
            --arg repo "${{ github.repository }}" \
            --arg author "${{ steps.pr-info.outputs.author_type }}" \
            --arg url "${{ steps.verify-cloudflare.outputs.url }}" \
            '{pr_number: $pr, sha: $sha, source_repo: $repo, author_type: $author, wheel_url: $url}')

          echo "::group::Dispatch Payload"
          echo "$PAYLOAD" | jq .
          echo "::endgroup::"

          gh api "/repos/acryldata/connector-tests/dispatches" \
            -f event_type=oss-pr-connector-tests \
            --raw-field "client_payload=$PAYLOAD"

          echo "Dispatch sent successfully to acryldata/connector-tests"

      - name: On failure — set error commit status
        if: failure() && steps.pr-info.outputs.has_pr == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api "/repos/${{ github.repository }}/statuses/${{ steps.pr-info.outputs.sha }}" \
            -f state=error \
            -f context="connector-tests" \
            -f description="Failed to trigger connector tests (infra issue)"
