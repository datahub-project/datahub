name: PR Routing Test (Linear Shadow Mode)

# Shadow mode - logs which team Claude would route this PR to, without creating any Linear tickets.
# Used to validate routing quality before enabling multi-team Linear integration.
#
# To enable ticket creation, uncomment the "Create Linear Ticket" step below.
# Requires secrets:
#   ANTHROPIC_KEY_FOR_ROUTING - Anthropic API key
#   INGESTION_LINEAR_KEY      - Linear API key (only needed when ticket creation is enabled)

on:
  pull_request_target:
    types: [opened, reopened, ready_for_review]

env:
  LINEAR_TEAM_CONFIG: |
    [
      {
        "key": "ING",
        "team_id": "b1c9a278-522e-47cb-81af-8b860ead0c76",
        "assignee_id": "bb4daa2b-1748-4830-af1f-60198ebd9a63",
        "description": "Python ingestion framework, connectors, sources, and CLI tools for extracting metadata from external data sources. Any PR touching metadata-ingestion/ or metadata-ingestion-modules/ belongs to this team."
      },
      {
        "key": "CAT",
        "team_id": "56af88f4-c7c2-40f6-9858-dcba33a5f55e",
        "assignee_id": "bb4daa2b-1748-4830-af1f-60198ebd9a63",
        "description": "DataHub frontend (React/TypeScript, datahub-web-react), GraphQL API layer (datahub-graphql-core), and application-layer GMS services including auth, search API, entity services, and REST/OpenAPI endpoints"
      },
      {
        "key": "PFP",
        "team_id": "71e24163-bc3b-4dfb-bba5-3acb822830e3",
        "assignee_id": "854a61e3-dba9-4293-b527-f953bd742201",
        "description": "Platform infrastructure ‚Äî Ebean/database storage layer, Elasticsearch indexing, Kafka consumers (MAE/MCE/PE), GMS infrastructure (factories, wiring), metadata-utils, Docker, and Kubernetes"
      }
    ]

jobs:
  test-routing:
    runs-on: ubuntu-latest
    continue-on-error: true
    timeout-minutes: 5
    steps:
      - name: Skip draft PRs
        id: check-draft
        env:
          PR_DRAFT: ${{ github.event.pull_request.draft }}
        run: |
          if [ "$PR_DRAFT" = "true" ]; then
            echo "should_skip=true" >> "$GITHUB_OUTPUT"
            echo "‚è≠Ô∏è  Skipping - PR is in draft"
          else
            echo "should_skip=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Route PR to team
        if: steps.check-draft.outputs.should_skip == 'false'
        id: route-team
        env:
          GH_TOKEN: ${{ github.token }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_KEY_FOR_ROUTING }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
        run: |
          if FILES_JSON=$(gh pr view "$PR_NUMBER" --json files 2>/dev/null); then
            FILES_LIST=$(echo "$FILES_JSON" | jq -r '.files | map(.path) | join("\n")' 2>/dev/null || echo "")
          else
            FILES_LIST=""
          fi

          TEAM_DESCRIPTIONS=$(echo "$LINEAR_TEAM_CONFIG" | jq -r '.[] | "- " + .key + ": " + .description')

          PROMPT=$(cat <<PROMPT_EOF
          You are routing a GitHub PR to the correct engineering team for review. Based on the PR details below, respond with ONLY the team key (e.g. ING, CAT, PFP), or NONE if it doesn't clearly belong to any team.

          Teams:
          ${TEAM_DESCRIPTIONS}

          PR Title: ${PR_TITLE}
          PR Author: ${PR_AUTHOR}

          Files Changed:
          ${FILES_LIST}

          PR Description:
          ${PR_BODY}

          Respond with only the team key or NONE.
          PROMPT_EOF
          )

          PROMPT_JSON=$(echo "$PROMPT" | jq -Rs .)

          CLAUDE_RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -H "content-type: application/json" \
            -d "{\"model\": \"claude-haiku-4-5-20251001\", \"max_tokens\": 10, \"messages\": [{\"role\": \"user\", \"content\": $PROMPT_JSON}]}")

          TEAM_KEY=$(echo "$CLAUDE_RESPONSE" | jq -r '.content[0].text' 2>/dev/null | tr -d '[:space:]' | tr '[:lower:]' '[:upper:]')

          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üîÄ Routing result for PR #$PR_NUMBER"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "Title:  $PR_TITLE"
          echo "Author: $PR_AUTHOR"
          echo ""

          if [ -z "$TEAM_KEY" ] || [ "$TEAM_KEY" = "NONE" ] || [ "$TEAM_KEY" = "NULL" ]; then
            echo "ü§∑ Would route to: NONE (no matching team)"
            echo "team_key=" >> "$GITHUB_OUTPUT"
          else
            TEAM_CONFIG=$(echo "$LINEAR_TEAM_CONFIG" | jq --arg key "$TEAM_KEY" '.[] | select(.key == $key)')
            if [ -z "$TEAM_CONFIG" ]; then
              echo "‚ö†Ô∏è  Claude returned unrecognized key: $TEAM_KEY"
              echo "team_key=" >> "$GITHUB_OUTPUT"
            else
              echo "‚úÖ Would route to: $TEAM_KEY"
              {
                echo "team_key=$TEAM_KEY"
                echo "team_id=$(echo "$TEAM_CONFIG" | jq -r '.team_id')"
                echo "assignee_id=$(echo "$TEAM_CONFIG" | jq -r '.assignee_id')"
              } >> "$GITHUB_OUTPUT"
            fi
          fi

          echo ""
          echo "Files that influenced this decision:"
          echo "$FILES_LIST" | head -20
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

      # Uncomment this step to enable actual Linear ticket creation
      # - name: Create Linear Ticket
      #   if: steps.check-draft.outputs.should_skip == 'false' && steps.route-team.outputs.team_key != ''
      #   env:
      #     GH_TOKEN: ${{ github.token }}
      #     GH_REPO: ${{ github.repository }}
      #     LINEAR_API_KEY: ${{ secrets.INGESTION_LINEAR_KEY }}
      #     PR_TITLE: ${{ github.event.pull_request.title }}
      #     PR_URL: ${{ github.event.pull_request.html_url }}
      #     PR_AUTHOR: ${{ github.event.pull_request.user.login }}
      #     PR_NUMBER: ${{ github.event.pull_request.number }}
      #     PR_BODY: ${{ github.event.pull_request.body }}
      #     FILES_CHANGED: ${{ github.event.pull_request.changed_files }}
      #     ADDITIONS: ${{ github.event.pull_request.additions }}
      #     DELETIONS: ${{ github.event.pull_request.deletions }}
      #     CONTRIBUTOR_TYPE: ${{ steps.check-author.outputs.contributor_type }}
      #     TEAM_KEY: ${{ steps.route-team.outputs.team_key }}
      #     TEAM_ID: ${{ steps.route-team.outputs.team_id }}
      #     ASSIGNEE_ID: ${{ steps.route-team.outputs.assignee_id }}
      #   run: |
      #     # Check for existing Linear ticket (deduplication guard)
      #     if COMMENTS_JSON=$(gh pr view "$PR_NUMBER" --json comments 2>/dev/null); then
      #       EXISTING=$(echo "$COMMENTS_JSON" | jq -r '.comments[].body' 2>/dev/null | grep -oP 'Linear: [A-Z]+-\d+' | head -n1 || echo "")
      #       if [ -n "$EXISTING" ]; then
      #         echo "‚è≠Ô∏è  Linear ticket already exists ($EXISTING), skipping"
      #         exit 0
      #       fi
      #     fi
      #
      #     if [ -z "$PR_BODY" ]; then
      #       PR_BODY="No description provided"
      #     fi
      #
      #     if FILES_JSON=$(gh pr view "$PR_NUMBER" --json files 2>/dev/null); then
      #       FILES_LIST=$(echo "$FILES_JSON" | jq -r '.files[:20] | map("- `" + .path + "`") | join("\n")' 2>/dev/null || echo "- Unable to fetch file list")
      #       if [ "$FILES_CHANGED" -gt 20 ]; then
      #         FILES_LIST="${FILES_LIST}\n- ... and $((FILES_CHANGED - 20)) more files"
      #       fi
      #     else
      #       FILES_LIST="- Unable to fetch file list"
      #     fi
      #
      #     if REVIEWERS_JSON=$(gh pr view "$PR_NUMBER" --json reviewRequests 2>/dev/null); then
      #       REVIEWERS=$(echo "$REVIEWERS_JSON" | jq -r '.reviewRequests | map("@" + .login) | join(", ")' 2>/dev/null || echo "None")
      #       if [ -z "$REVIEWERS" ] || [ "$REVIEWERS" = "" ]; then
      #         REVIEWERS="None"
      #       fi
      #     else
      #       REVIEWERS="Unable to fetch"
      #     fi
      #
      #     DESCRIPTION=$(cat <<DESCRIPTION_EOF
      #     Review PR #${PR_NUMBER} from @${PR_AUTHOR} (${CONTRIBUTOR_TYPE})
      #
      #     ${PR_URL}
      #
      #     ## Description
      #     ${PR_BODY}
      #
      #     ## Changes
      #     - **Files changed**: ${FILES_CHANGED}
      #     - **Lines**: +${ADDITIONS} / -${DELETIONS}
      #     - **Requested reviewers**: ${REVIEWERS}
      #
      #     ## Files Changed
      #     ${FILES_LIST}
      #     DESCRIPTION_EOF
      #     )
      #
      #     TITLE="[PR Review] $PR_TITLE"
      #
      #     if ! TITLE_JSON=$(echo "$TITLE" | jq -Rs . 2>/dev/null) || [ -z "$TITLE_JSON" ]; then
      #       echo "‚ùå Failed to JSON-encode title"
      #       exit 0
      #     fi
      #
      #     if ! DESCRIPTION_JSON=$(echo "$DESCRIPTION" | jq -Rs . 2>/dev/null) || [ -z "$DESCRIPTION_JSON" ]; then
      #       echo "‚ùå Failed to JSON-encode description"
      #       exit 0
      #     fi
      #
      #     MUTATION=$(cat <<EOF
      #     {
      #       "query": "mutation CreateIssue(\$input: IssueCreateInput!) { issueCreate(input: \$input) { success issue { id identifier title url } } }",
      #       "variables": {
      #         "input": {
      #           "teamId": "$TEAM_ID",
      #           "title": $TITLE_JSON,
      #           "description": $DESCRIPTION_JSON,
      #           "assigneeId": "$ASSIGNEE_ID"
      #         }
      #       }
      #     }
      #     EOF
      #     )
      #
      #     RESPONSE=$(curl -s -X POST https://api.linear.app/graphql \
      #       -H "Authorization: $LINEAR_API_KEY" \
      #       -H "Content-Type: application/json" \
      #       -d "$MUTATION")
      #
      #     if [ -z "$RESPONSE" ]; then
      #       echo "‚ùå Empty response from Linear API"
      #       exit 0
      #     fi
      #
      #     SUCCESS=$(echo "$RESPONSE" | jq -r '.data.issueCreate.success' 2>/dev/null)
      #     if [ "$SUCCESS" = "true" ]; then
      #       ISSUE_ID=$(echo "$RESPONSE" | jq -r '.data.issueCreate.issue.identifier')
      #       ISSUE_URL=$(echo "$RESPONSE" | jq -r '.data.issueCreate.issue.url')
      #       echo "‚úÖ Created Linear ticket: $ISSUE_ID ($TEAM_KEY)"
      #       echo "üìé $ISSUE_URL"
      #
      #       if ! gh pr comment "$PR_NUMBER" --body "Linear: $ISSUE_ID" 2>/dev/null; then
      #         echo "‚ö†Ô∏è  Created ticket but failed to comment on PR"
      #       fi
      #     else
      #       echo "‚ùå Failed to create Linear ticket"
      #       echo "$RESPONSE" | jq . 2>/dev/null || echo "$RESPONSE"
      #       exit 0
      #     fi
