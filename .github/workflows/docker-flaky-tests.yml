name: Flaky Tests Validation
# This workflow runs flaky Cypress tests 5 times in parallel against head images
on:
  workflow_dispatch:
  push:
    branches:
      - master
      - cr-oss-flake-tester

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  DOCKER_REGISTRY: "docker.io"
  DOCKER_REPOSITORY: "acryldata"
  DOCKER_CACHE: "DEPOT"
  DEPOT_PROJECT_ID: "${{ vars.DEPOT_PROJECT_ID }}"
  DEPOT_TOKEN: "${{ secrets.DEPOT_TOKEN }}"

permissions:
  contents: read
  id-token: write

jobs:
  check_changes:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
      - name: Check out the repo
        uses: acryldata/sane-checkout-action@v4
        with:
          fetch-depth: 0

      - name: Check if flaky tests need to run
        id: check
        run: |
          # If manual trigger, always run
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "should_run=true" >> "$GITHUB_OUTPUT"
            echo "Manual trigger - will run tests"
            exit 0
          fi

          # Get list of changed files in this push
          CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})

          # Check if flaky-tests.txt itself changed
          if echo "$CHANGED_FILES" | grep -q "smoke-test/flaky-tests.txt"; then
            echo "should_run=true" >> "$GITHUB_OUTPUT"
            echo "flaky-tests.txt was modified - will run tests"
            exit 0
          fi

          # Read test files from flaky-tests.txt and check if any changed
          if [[ -f "smoke-test/flaky-tests.txt" ]]; then
            while IFS= read -r test_file; do
              # Skip empty lines and comments
              [[ -z "$test_file" || "$test_file" =~ ^# ]] && continue

              # Build full path to test file
              full_path="smoke-test/tests/cypress/cypress/e2e/$test_file"

              # Check if this test file was modified
              if echo "$CHANGED_FILES" | grep -q "$full_path"; then
                echo "should_run=true" >> "$GITHUB_OUTPUT"
                echo "Test file $test_file was modified - will run tests"
                exit 0
              fi
            done < "smoke-test/flaky-tests.txt"
          fi

          # No relevant changes found
          echo "should_run=false" >> "$GITHUB_OUTPUT"
          echo "No flaky test files changed - skipping tests"

  setup:
    runs-on: depot-ubuntu-24.04-small
    needs: [check_changes]
    if: needs.check_changes.outputs.should_run == 'true'
    outputs:
      tag: ${{ steps.tag.outputs.tag }}
      date_tag: ${{ steps.tag.outputs.date_tag }}
      docker-login: ${{ steps.docker-login.outputs.docker-login }}
      python_release_version: ${{ steps.tag.outputs.python_release_version }}
      branch_name: ${{ steps.tag.outputs.branch_name }}
      repository_name: ${{ steps.tag.outputs.repository_name }}
      test_runner_type: ${{ steps.set-runner.outputs.test_runner_type }}
      test_runner_type_small: ${{ steps.set-runner.outputs.test_runner_type_small }}
      use_depot_cache: ${{ steps.set-runner.outputs.use_depot_cache }}
      uv_cache_key: ${{ steps.uv-cache-key.outputs.uv_cache_key }}
      uv_cache_key_prefix: ${{ steps.uv-cache-key.outputs.uv_cache_key_prefix }}
      yarn_cache_key: ${{ steps.yarn-cache-key.outputs.yarn_cache_key }}
      yarn_cache_key_prefix: ${{ steps.yarn-cache-key.outputs.yarn_cache_key_prefix }}
      datahub_images: ${{ steps.collect-images.outputs.datahub_images }}
    steps:
      - name: Check out the repo
        uses: acryldata/sane-checkout-action@v4
      - name: Compute Tag
        id: tag
        env:
          GITHUB_REF_FALLBACK: ${{ github.ref }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
        run: |
          source .github/scripts/docker_helpers.sh
          # Get current date in YYYY-MM-DD format
          CURRENT_DATE=$(date +%Y-%m-%d)
          {
            echo "tag=flaky-test"
            echo "date_tag=flaky-test-${CURRENT_DATE}"
            echo "python_release_version=$(get_python_docker_release_v)"
            echo "branch_name=${GITHUB_REF#refs/heads/}"
            echo "repository_name=${GITHUB_REPOSITORY#*/}"
          } >> "$GITHUB_OUTPUT"
      - name: Check whether docker login is possible
        id: docker-login
        env:
          ENABLE_DOCKER_LOGIN: ${{ secrets.ACRYL_DOCKER_USERNAME != '' && secrets.ACRYL_DOCKER_PASSWORD != '' }}
        run: |
          echo "Enable Docker Login: ${{ env.ENABLE_DOCKER_LOGIN }}"
          echo "docker-login=${{ env.ENABLE_DOCKER_LOGIN }}" >> "$GITHUB_OUTPUT"

      - name: Determine runner type
        id: set-runner
        run: |
          if [[ "${{ env.DOCKER_CACHE }}" == "DEPOT" && "${{ env.DEPOT_PROJECT_ID }}" != "" ]]; then
            echo "test_runner_type=depot-ubuntu-24.04-4" >> "$GITHUB_OUTPUT"
            echo "test_runner_type_small=depot-ubuntu-24.04-small" >> "$GITHUB_OUTPUT"
            echo "use_depot_cache=true" >> "$GITHUB_OUTPUT"
          else
            echo "test_runner_type=ubuntu-latest" >> "$GITHUB_OUTPUT"
            echo "test_runner_type_small=ubuntu-latest" >> "$GITHUB_OUTPUT"
            echo "use_depot_cache=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Compute UV Cache Key
        id: uv-cache-key
        run: |
          echo "uv_cache_key=docker-flaky-tests-${{ runner.os }}-uv-${{ hashFiles(
            './datahub-actions/pyproject.toml',
            './datahub-actions/setup.py',
            './smoke-test/requirements.txt',
            './smoke-test/pyproject.toml',
            './metadata-ingestion/pyproject.toml',
            './metadata-ingestion/setup.py') }}" >> "$GITHUB_OUTPUT"
          echo "uv_cache_key_prefix=docker-flaky-tests-${{ runner.os }}-uv-" >> "$GITHUB_OUTPUT"

      - name: Compute Yarn Cache Key
        id: yarn-cache-key
        run: |
          echo "yarn_cache_key=docker-flaky-tests-${{ runner.os }}-yarn-${{ hashFiles('./smoke-test/tests/cypress/yarn.lock', './datahub-web-react/yarn.lock') }}" >> "$GITHUB_OUTPUT"
          echo "yarn_cache_key_prefix=docker-flaky-tests-${{ runner.os }}-yarn-" >> "$GITHUB_OUTPUT"

      - name: Download build Metadata for latest head build
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          run_id=$(gh run list  --workflow="docker-unified.yml" --branch master --status success --limit 1 --json=databaseId  | jq '.[].databaseId')
          mkdir -p ${{ github.workspace }}/build
          gh api repos/datahub-project/datahub/actions/runs/$run_id/artifacts --jq '.artifacts[] | select(.name == "build-metadata-head") | .id' |  xargs -I {} gh api repos/datahub-project/datahub/actions/artifacts/{}/zip >${{ github.workspace }}/build/build-metadata.zip
          unzip ${{ github.workspace }}/build/build-metadata.zip -d ${{ github.workspace }}/build/
          ls -l ${{ github.workspace }}/build/

      - name: Collect image:tag from build log
        id: collect-images
        run: |
          # contains full repo/image:tag for all published images (includes all variants)
          images="$(depot bake -f ${{ github.workspace }}/build/bake-spec-allImages.json --print |  jq -cr '.target[].tags[]' | grep 'head' | tr '\n' ' ')"

          echo "datahub_images=$(echo $images)" >> "$GITHUB_OUTPUT"

      - name: Show collected images
        run: |
          echo "${{ steps.collect-images.outputs.datahub_images }}"

  run_flaky_tests:
    name: Run Flaky Tests (Run ${{ matrix.run_number }})
    runs-on: ${{ needs.setup.outputs.test_runner_type }}
    needs: [check_changes, setup]
    if: needs.check_changes.outputs.should_run == 'true'
    strategy:
      fail-fast: false
      matrix:
        run_number: [1, 2, 3, 4, 5]
        profile: [quickstart-consumers]
    env:
      MIXPANEL_API_SECRET: ${{ secrets.MIXPANEL_API_SECRET }}
      MIXPANEL_PROJECT_ID: ${{ secrets.MIXPANEL_PROJECT_ID }}
    steps:
      - name: Free up disk space
        if: ${{ !contains(needs.setup.outputs.test_runner_type, 'depot') }}
        run: |
          sudo apt-get remove 'dotnet-*' azure-cli || true
          sudo rm -rf /usr/local/lib/android/ || true
          sudo docker image prune -a -f || true

      - uses: actions/cache/restore@v4
        with:
          path: |
            ~/.cache/uv
          key: ${{ needs.setup.outputs.uv_cache_key }}
          restore-keys: |
            ${{ needs.setup.outputs.uv_cache_key_prefix }}

      - uses: actions/cache/restore@v4
        with:
          path: |
            ~/.cache/yarn
          key: ${{ needs.setup.outputs.yarn_cache_key }}
          restore-keys: |
            ${{ needs.setup.outputs.yarn_cache_key_prefix }}

      - name: Check out the repo
        uses: acryldata/sane-checkout-action@v4
        with:
          checkout-head-only: false

      - name: Set up Depot CLI
        if: ${{ needs.setup.outputs.use_depot_cache == 'true' }}
        uses: depot/setup-action@v1

      - uses: actions/setup-python@v6
        with:
          python-version: "3.11"
          cache: "pip"

      - uses: gradle/actions/setup-gradle@v4
        if: ${{ needs.setup.outputs.use_depot_cache != 'true' }}

      - name: Login to registry
        uses: docker/login-action@v3
        if: ${{ needs.setup.outputs.docker-login == 'true' && env.DOCKER_REGISTRY == 'docker.io' }}
        with:
          username: ${{ secrets.ACRYL_DOCKER_USERNAME }}
          password: ${{ secrets.ACRYL_DOCKER_PASSWORD }}

      - name: Download build Metadata for latest head build
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          run_id=$(gh run list  --workflow="docker-unified.yml" --branch master --status success --limit 1 --json=databaseId  | jq '.[].databaseId')
          mkdir -p ${{ github.workspace }}/build
          gh api repos/datahub-project/datahub/actions/runs/$run_id/artifacts --jq '.artifacts[] | select(.name == "build-metadata-head") | .id' |  xargs -I {} gh api repos/datahub-project/datahub/actions/artifacts/{}/zip >${{ github.workspace }}/build/build-metadata.zip
          unzip ${{ github.workspace }}/build/build-metadata.zip -d ${{ github.workspace }}/build/
          ls -l ${{ github.workspace }}/build/

      - name: Collect image:tag from build log
        id: collect-images
        run: |
          # contains full repo/image:tag for all published images (includes all variants)
          images="$(depot bake -f ${{ github.workspace }}/build/bake-spec-allImages.json --print |  jq -cr '.target[].tags[]' | grep 'head' | tr '\n' ' ')"

          echo "datahub_images=$(echo $images)" >> "$GITHUB_OUTPUT"

      - name: Show collected images
        run: |
          echo "${{ steps.collect-images.outputs.datahub_images }}"

      - name: Pull head images from registry
        run: |
          echo collected images "${{ steps.collect-images.outputs.datahub_images }}"
          # Pull the latest head/master images from registry
          failed_pulls=0
          eval "set -- ${{ steps.collect-images.outputs.datahub_images }}"
          for image do
            if [ -n "$image" ]; then
              echo "Pulling $image"
              if ! docker pull "$image"; then
                echo "Failed to pull $image"
                failed_pulls=$((failed_pulls + 1))
              else
                # Re-tag the head image with the flaky-test tag for smoke tests
                newImage=${image/\:head/\:${{ needs.setup.outputs.tag }}}
                echo "Tagging $image as $newImage"
                docker tag "$image" "$newImage"
              fi
            fi
          done

          if [ $failed_pulls -gt 0 ]; then
            echo "Warning: $failed_pulls images failed to pull"
          fi

          docker images

      - name: run quickstart
        env:
          DATAHUB_TELEMETRY_ENABLED: false
          DATAHUB_VERSION: ${{ needs.setup.outputs.tag }}
          DATAHUB_ACTIONS_IMAGE: ${{ env.DOCKER_REPOSITORY }}/datahub-actions:head
          ACTIONS_EXTRA_PACKAGES: "acryl-datahub-actions[executor] acryl-datahub-actions"
          ACTIONS_CONFIG: "https://raw.githubusercontent.com/acryldata/datahub-actions/main/docker/config/executor.yaml"
          PROFILE_NAME: ${{ matrix.profile }}
        run: |
          ./smoke-test/run-quickstart.sh

      - name: Disk Check
        run: df -h . && docker images

      - name: Disable ES Disk Threshold
        run: |
          curl -XPUT "http://localhost:9200/_cluster/settings" \
          -H 'Content-Type: application/json' -d'{
            "persistent": {
              "cluster": {
                "routing": {
                  "allocation.disk.threshold_enabled": false
                }
              }
            }
          }'

      - name: Install dependencies
        run: ./metadata-ingestion/scripts/install_deps.sh

      - name: Build datahub cli
        run: |
          ./gradlew :metadata-ingestion:install

      - name: Run flaky tests
        env:
          RUN_QUICKSTART: false
          DATAHUB_VERSION: ${{ needs.setup.outputs.tag }}
          CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_RECORD_KEY }}
          CLEANUP_DATA: "false"
          TEST_STRATEGY: "cypress"
          BATCH_COUNT: "1"
          BATCH_NUMBER: "0"
          FILTERED_TESTS: "smoke-test/flaky-tests.txt"
          PROFILE_NAME: ${{ matrix.profile }}
        run: |
          echo "$DATAHUB_VERSION"
          ./gradlew --stop
          ./smoke-test/smoke.sh

      - name: Disk Check
        run: df -h . && docker images

      - name: store logs
        if: failure()
        run: |
          docker ps -a
          TEST_STRATEGY="-cypress"
          source .github/scripts/docker_logs.sh
      - name: Upload logs
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: docker-logs-run-${{ matrix.run_number }}
          path: "docker_logs/*.log"
          retention-days: 5
      - name: Upload screenshots
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: cypress-snapshots-run-${{ matrix.run_number }}
          path: smoke-test/tests/cypress/cypress/screenshots/
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: Test Results (flaky tests) Run ${{ matrix.run_number }}
          path: |
            **/build/reports/tests/test/**
            **/build/test-results/test/**
            **/smoke-test-results/cypress-test-*.xml
            **/junit.*.xml
            !**/binary/**
      - name: Upload test results to Codecov
        if: ${{ !cancelled() }}
        uses: codecov/test-results-action@v1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          override_branch: ${{ github.head_ref || github.ref_name }}

      - uses: actions/cache/save@v4
        if: ${{ matrix.run_number == 1 }}
        with:
          path: |
            ~/.cache/uv
          key: ${{ needs.setup.outputs.uv_cache_key }}

      - uses: actions/cache/save@v4
        if: ${{ matrix.run_number == 1 }}
        with:
          path: |
            ~/.cache/yarn
          key: ${{ needs.setup.outputs.yarn_cache_key }}
