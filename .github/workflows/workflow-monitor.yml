name: Workflow Monitor

on:
  workflow_run:
    workflows:
      - "Docker Build, Scan, Test"
      - "build & test"
      - "metadata-io"
    types: [completed]

permissions:
  actions: write # Required to retrigger workflows
  contents: read

jobs:
  monitor:
    name: Monitor Workflow Completion
    runs-on: ubuntu-latest

    steps:
      - name: Print workflow summary
        run: |
          echo "## Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Workflow Name** | ${{ github.event.workflow_run.name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch** | ${{ github.event.workflow_run.head_branch }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Event** | ${{ github.event.workflow_run.event }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Start Time** | ${{ github.event.workflow_run.created_at }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **End Time** | ${{ github.event.workflow_run.updated_at }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Completion Status** | ${{ github.event.workflow_run.conclusion }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Run Number** | ${{ github.event.workflow_run.run_attempt }} |" >> $GITHUB_STEP_SUMMARY

          echo "Workflow '${{ github.event.workflow_run.name }}' completed"
          echo "  Status: ${{ github.event.workflow_run.conclusion }}"
          echo "  Branch: ${{ github.event.workflow_run.head_branch }}"
          echo "  Event: ${{ github.event.workflow_run.event }}"
          echo "  Run Attempt: ${{ github.event.workflow_run.run_attempt }}"

          # TODO: This info needs to be published to something like posthog or equivalent for analysis.

      - name: Retrigger docker-unified on first failure
        if: |
          github.event.workflow_run.name == 'Docker Build, Scan, Test' &&
          github.event.workflow_run.conclusion == 'failure' &&
          github.event.workflow_run.run_attempt == 1
        continue-on-error: true
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Retry Decision" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ **Retriggering workflow** (first failure detected)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "Retriggering '${{ github.event.workflow_run.name }}' (Run ID: ${{ github.event.workflow_run.id }})..."

          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}/rerun-failed-jobs

          EXIT_CODE=$?

          if [ $EXIT_CODE -eq 0 ]; then
            echo "✅ Successfully triggered workflow retry" | tee -a $GITHUB_STEP_SUMMARY
          else
            echo "❌ Failed to retrigger workflow (exit code: $EXIT_CODE)" | tee -a $GITHUB_STEP_SUMMARY
          fi
