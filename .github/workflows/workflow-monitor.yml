name: Workflow Monitor

on:
  workflow_run:
    workflows:
      - "Docker Build, Scan, Test"
      - "build & test"
      - "metadata-io"
    types: [completed]

permissions:
  actions: write # Required to retrigger workflows
  contents: read

jobs:
  monitor:
    name: Monitor Workflow Completion
    runs-on: ubuntu-latest
    if: github.event.workflow_run.head_repository.full_name == github.repository

    steps:
      - name: Print workflow summary
        env:
          WORKFLOW_NAME: ${{ github.event.workflow_run.name }}
          HEAD_BRANCH: ${{ github.event.workflow_run.head_branch }}
          WORKFLOW_EVENT: ${{ github.event.workflow_run.event }}
          CREATED_AT: ${{ github.event.workflow_run.created_at }}
          UPDATED_AT: ${{ github.event.workflow_run.updated_at }}
          CONCLUSION: ${{ github.event.workflow_run.conclusion }}
          RUN_ATTEMPT: ${{ github.event.workflow_run.run_attempt }}
        run: |
          echo "## Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Workflow Name** | $WORKFLOW_NAME |" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch** | $HEAD_BRANCH |" >> $GITHUB_STEP_SUMMARY
          echo "| **Event** | $WORKFLOW_EVENT |" >> $GITHUB_STEP_SUMMARY
          echo "| **Start Time** | $CREATED_AT |" >> $GITHUB_STEP_SUMMARY
          echo "| **End Time** | $UPDATED_AT |" >> $GITHUB_STEP_SUMMARY
          echo "| **Completion Status** | $CONCLUSION |" >> $GITHUB_STEP_SUMMARY
          echo "| **Run Number** | $RUN_ATTEMPT |" >> $GITHUB_STEP_SUMMARY

          echo "Workflow '$WORKFLOW_NAME' completed"
          echo "  Status: $CONCLUSION"
          echo "  Branch: $HEAD_BRANCH"
          echo "  Event: $WORKFLOW_EVENT"
          echo "  Run Attempt: $RUN_ATTEMPT"

          # TODO: This info needs to be published to something like posthog or equivalent for analysis.

      - name: Retrigger docker-unified on first failure
        if: |
          github.event.workflow_run.name == 'Docker Build, Scan, Test' &&
          github.event.workflow_run.conclusion == 'failure' &&
          github.event.workflow_run.run_attempt == 1
        continue-on-error: true
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Retry Decision" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ **Retriggering workflow** (first failure detected)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "Retriggering '${{ github.event.workflow_run.name }}' (Run ID: ${{ github.event.workflow_run.id }})..."

          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}/rerun-failed-jobs

          EXIT_CODE=$?

          if [ $EXIT_CODE -eq 0 ]; then
            echo "✅ Successfully triggered workflow retry" | tee -a $GITHUB_STEP_SUMMARY
          else
            echo "❌ Failed to retrigger workflow (exit code: $EXIT_CODE)" | tee -a $GITHUB_STEP_SUMMARY
          fi
