name: Metadata Ingestion
on:
  push:
    branches:
      - master
      - releases/**
    paths:
      - ".github/workflows/metadata-ingestion.yml"
      - "metadata-ingestion/**"
      - "metadata-ingestion-modules/**"
      - "metadata-models/**"
  pull_request:
    branches:
      - "**"
    paths:
      - ".github/workflows/metadata-ingestion.yml"
      - "metadata-ingestion/**"
      - "metadata-ingestion-modules/**"
      - "metadata-models/**"
  release:
    types: [published]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  DEPOT_PROJECT_ID: "${{ vars.DEPOT_PROJECT_ID }}"

jobs:
  ci:
    runs-on: ${{ vars.DEPOT_PROJECT_ID != '' && 'depot-ubuntu-latest-2' || 'ubuntu-latest' }}
    timeout-minutes: 60
    env:
      DATAHUB_TELEMETRY_ENABLED: false
      # TODO: Enable this once the test is fixed.
      # DATAHUB_LOOKML_GIT_TEST_SSH_KEY: ${{ secrets.DATAHUB_LOOKML_GIT_TEST_SSH_KEY }}
    strategy:
      matrix:
        python-version: ["3.11"]
        # command: [
        #     "testQuick", # also runs lint
        #     "testIntegrationBatch0",
        #     "testIntegrationBatch1",
        #     "testIntegrationBatch2",
        #     "testIntegrationBatch3",
        #     "testIntegrationBatch4",
        #     "testIntegrationBatch5",
        #     "testIntegrationBatchRecording", # Recording tests - isolated execution to avoid module patching interference
        #   ]
        coverage:
          [
            "integration/athena",
            "integration/azure_ad",
            "integration/azure_data_factory",
            "integration/bigquery_v2",
            "integration/business-glossary",
            "integration/cassandra",
            "integration/circuit_breaker",
            "integration/clickhouse",
            "integration/csv-enricher",
            "integration/dataplex",
            "integration/db2",
            "integration/dbt",
            "integration/delta_lake",
            "integration/dremio",
            "integration/druid",
            "integration/dynamodb",
            "integration/excel",
            "integration/feast",
            "integration/file",
            "integration/fivetran",
            "integration/git",
            "integration/grafana",
            "integration/hana",
            "integration/hex",
            "integration/hive",
            "integration/hive-metastore",
            "integration/iceberg",
            "integration/kafka",
            "integration/kafka-connect",
            "integration/kafka-connect-confluent-cloud",
            "integration/ldap",
            "integration/looker",
            "integration/lookml",
            "integration/metabase",
            "integration/mlflow",
            "integration/mode",
            "integration/mongodb",
            "integration/mysql",
            "integration/neo4j",
            "integration/nifi",
            "integration/okta",
            "integration/openapi",
            "integration/oracle",
            "integration/postgres",
            "integration/powerbi",
            "integration/powerbi_report_server",
            "integration/preset",
            "integration/qlik_sense",
            "integration/recording",
            "integration/redshift-usage",
            "integration/remote",
            "integration/s3",
            "integration/sac",
            "integration/salesforce",
            "integration/sigma",
            "integration/snaplogic",
            "integration/snowflake",
            "integration/sql_queries",
            "integration/sql_server",
            "integration/starburst-trino-usage",
            "integration/superset",
            "integration/tableau",
            "integration/test_masking_integration.py",
            "integration/trino",
            "integration/unity",
            "integration/vertexai",
            "integration/vertica",

            "unit/abs",
            "unit/api",
            "unit/autogenerated",
            "unit/azure_data_factory",
            "unit/bigquery",
            "unit/cli",
            "unit/config",
            "unit/configuration",
            "unit/data_lake",
            "unit/datahub",
            "unit/dataplex",
            "unit/dbt",
            "unit/dremio",
            "unit/excel",
            "unit/fivetran",
            "unit/glue",
            "unit/grafana",
            "unit/hex",
            "unit/hive_test_utils.py",
            "unit/ingestion",
            "unit/looker",
            "unit/lookml",
            "unit/mock_data",
            "unit/patch",
            "unit/powerbi",
            "unit/recording",
            "unit/redshift",
            "unit/reporting",
            "unit/s3",
            "unit/sagemaker",
            "unit/schema",
            "unit/sdk",
            "unit/sdk_v2",
            "unit/secret",
            "unit/serde",
            "unit/snowflake",
            "unit/sql_parsing",
            "unit/sql_queries",
            "unit/stateful_ingestion",
            "unit/stored_procedure",
            "unit/structured_properties",
            "unit/tableau",
            "unit/test_athena_*.py",
            "unit/test_aws_common.py",
            "unit/test_bootstrap.py",
            "unit/test_business_glossary.py",
            "unit/test_capability_report.py",
            "unit/test_cassandra_source.py",
            "unit/test_classification_mixin.py",
            "unit/test_classification.py",
            "unit/test_clickhouse_source.py",
            "unit/test_cockroach_source.py",
            "unit/test_compare_metadata.py",
            "unit/test_confluent_schema_registry.py",
            "unit/test_csv_enricher_source.py",
            "unit/test_datahub_source.py",
            "unit/test_db2_source.py",
            "unit/test_druid_source.py",
            "unit/test_elasticsearch_source.py",
            "unit/test_exception_hook.py",
            "unit/test_file_*.py",
            "unit/test_gc.py",
            "unit/test_gcs_source.py",
            "unit/test_ge_profiling_config.py",
            "unit/test_generic_aspect_transformer.py",
            "unit/test_hana_source.py",
            "unit/test_hive_*.py",
            "unit/test_iceberg.py",
            "unit/test_kafka_*.py",
            "unit/test_ldap_source.py",
            "unit/test_library_examples.py",
            "unit/test_logging_utils.py",
            "unit/test_mapping.py",
            "unit/test_mariadb_source.py",
            "unit/test_masking_*.py",
            "unit/test_metabase_source.py",
            "unit/test_mlflow_source.py",
            "unit/test_mongodb_source.py",
            "unit/test_mssql_upstream_alias_filtering.py",
            "unit/test_mssql.py",
            "unit/test_mysql_rds_iam.py",
            "unit/test_neo4j_source.py",
            "unit/test_nifi_source.py",
            "unit/test_openapi.py",
            "unit/test_oracle_source.py",
            "unit/test_packages.py",
            "unit/test_packaging.py",
            "unit/test_postgres_*.py",
            "unit/test_powerbi_parser.py",
            "unit/test_preset_source.py",
            "unit/test_protobuf_util.py",
            "unit/test_pulsar_source.py",
            "unit/test_rds_iam_utils.py",
            "unit/test_redash_source.py",
            "unit/test_rest_sink.py",
            "unit/test_schema_util.py",
            "unit/test_secret_registry.py",
            "unit/test_source.py",
            "unit/test_sql_*.py",
            "unit/test_superset_source.py",
            "unit/test_teradata_*.py",
            "unit/test_teradata_source.py",
            "unit/test_transform_dataset.py",
            "unit/test_unity_*.py",
            "unit/test_usage_common.py",
            "unit/test_user_add.py",
            "unit/test_vertexai_source.py",
            "unit/test_vertica_source.py",
            "unit/transformers",
            "unit/urns",
            "unit/utilities",
          ]
        include:
          # Version compatibility tests.
          - python-version: "3.9"
            command: "testQuick"
      fail-fast: false
    steps:
      - name: Free up disk space
        run: |
          sudo apt-get remove 'dotnet-*' azure-cli || true
          sudo rm -rf /usr/local/lib/android/ || true
          sudo docker image prune -a -f || true
      - name: Set up JDK 17
        uses: actions/setup-java@v5
        with:
          distribution: "zulu"
          java-version: 17
      - uses: gradle/actions/setup-gradle@v4
      - uses: acryldata/sane-checkout-action@v4
        with:
          checkout-head-only: false
      - uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}
      - uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
          key: ${{ runner.os }}-uv-${{ hashFiles('**/requirements.txt') }}
      - name: Install dependencies
        run: ./metadata-ingestion/scripts/install_deps.sh
      - name: Install ODBC driver for mssql tests
        run: ./metadata-ingestion/scripts/install_odbc_for_mssql_tests.sh
      - name: Install package with test dependencies
        run: ./gradlew :metadata-ingestion:installDevTest
      # - name: Check lint passes and autogenerated JSON files are up-to-date
      #   if: ${{  matrix.command == 'testQuick' }}
      #   run: |
      #     ./gradlew :metadata-ingestion:lint
      # - name: Check autogenerated JSON files are up-to-date
      #   if: ${{  matrix.command == 'testQuick' }}
      #   run: |
      #     ./gradlew :metadata-ingestion:capabilitySummary :metadata-ingestion:lineageGen
      #     for json_file in metadata-ingestion/src/datahub/ingestion/autogenerated/*.json; do
      #       filename=$(basename "$json_file")
      #       if git diff --quiet "$json_file"; then
      #         echo "✅ $filename is unchanged"
      #       else
      #         echo "❌ $filename has changed. Please commit the updated file."
      #         echo "Changed lines:"
      #         git diff "$json_file"
      #         exit 1
      #       fi
      #     done
      - name: Run metadata-ingestion tests
        working-directory: metadata-ingestion
        run: |
          bash -c "venv/bin/pytest --durations=20 -vv --continue-on-collection-errors --random-order --junit-xml=junit.quick.xml ${{ matrix.coverage }}"
      - name: Debug info
        if: always()
        run: |
          source metadata-ingestion/venv/bin/activate && uv pip freeze
          set -x
          df -hl
          docker image ls
          docker system df
      # - uses: actions/upload-artifact@v4
      #   with:
      #     name: Test Results (metadata ingestion ${{ matrix.python-version }} ${{ matrix.command }})
      #     path: |
      #       **/build/reports/tests/test/**
      #       **/build/test-results/test/**
      #       **/junit.*.xml
      #       !**/binary/**
      # - name: Upload coverage to Codecov with ingestion flag
      #   if: ${{ always() && matrix.python-version == '3.11' }}
      #   uses: codecov/codecov-action@v5
      #   with:
      #     token: ${{ secrets.CODECOV_TOKEN }}
      #     directory: ./build/coverage-reports/metadata-ingestion/
      #     fail_ci_if_error: false
      #     flags: ingestion
      #     name: pytest-${{ matrix.python-version }}-${{ matrix.command }}
      #     verbose: true
      #     override_branch: ${{ github.head_ref || github.ref_name }}
      # - name: Upload test results to Codecov
      #   if: ${{ !cancelled() }}
      #   uses: codecov/test-results-action@v1
      #   with:
      #     token: ${{ secrets.CODECOV_TOKEN }}
      #     override_branch: ${{ github.head_ref || github.ref_name }}

  event-file:
    runs-on: ubuntu-latest
    steps:
      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: Event File
          path: ${{ github.event_path }}
