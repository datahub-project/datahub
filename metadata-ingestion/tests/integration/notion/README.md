# Notion Integration Tests

Integration tests for the DataHub Notion connector that validate real-world scenarios against the Notion API.

## Overview

These tests create actual pages in your Notion workspace to validate:

1. **SyncBlock Compatibility** - Tests ingestion of pages with synced blocks (original and reference)
2. **NumberedListItem Support** - Tests ingestion of numbered lists with new Notion API fields
3. **Credential Validation** - Tests early warning system for missing AWS/Cohere credentials
4. **Full Ingestion** - Tests end-to-end ingestion with all monkeypatches applied

## Prerequisites

### 1. Create a Notion Integration

1. Go to [Notion Integrations](https://www.notion.so/my-integrations)
2. Click **"+ New integration"**
3. Name it "DataHub Test Integration" (or similar)
4. Select your workspace
5. Enable **Read content** capability
6. Click **Submit**
7. Copy the **Internal Integration Token** (starts with `secret_...`)

### 2. Create a Test Parent Page

1. Create a new page in Notion called "DataHub Test Pages" (or similar)
2. Share this page with your test integration:
   - Click the **"..."** menu (top right)
   - Select **"Add connections"**
   - Choose your test integration
3. Copy the page ID from the URL:
   - URL format: `https://www.notion.so/Page-Title-{PAGE_ID}`
   - The ID is the 32-character hex string (with or without hyphens)

## Running the Tests

### Set Environment Variables

```bash
# Required: Notion API credentials
export NOTION_API_KEY="secret_abc123..."
export NOTION_TEST_PARENT_PAGE_ID="abc123def456abc123def456abc123de"

# Optional: For embedding credential tests
export AWS_ACCESS_KEY_ID="your-aws-key"  # For Bedrock tests
export COHERE_API_KEY="your-cohere-key"  # For Cohere tests
```

### Run All Notion Integration Tests

From the repository root:

```bash
cd metadata-ingestion
../gradlew :metadata-ingestion:testQuick -PtestFile=tests/integration/notion/test_notion_integration.py
```

Or using pytest directly (after activating venv):

```bash
pytest tests/integration/notion/test_notion_integration.py -v
```

### Run Specific Tests

```bash
# Test synced blocks only
pytest tests/integration/notion/test_notion_integration.py::test_notion_synced_blocks_ingestion -v

# Test numbered lists only
pytest tests/integration/notion/test_notion_integration.py::test_notion_numbered_lists_ingestion -v

# Test credential warnings
pytest tests/integration/notion/test_notion_integration.py::test_notion_bedrock_credential_warning -v
```

### Skip Tests Without Credentials

If `NOTION_API_KEY` or `NOTION_TEST_PARENT_PAGE_ID` are not set, all tests will be automatically skipped with a clear message:

```
SKIPPED [7] tests/integration/notion/conftest.py:16: NOTION_API_KEY and NOTION_TEST_PARENT_PAGE_ID environment variables must be set for Notion integration tests
```

## Test Fixtures

### Session-Scoped Fixtures

These fixtures create test pages once per test session and clean them up afterward:

- **`notion_client`** - Authenticated Notion API client
- **`notion_test_parent_page_id`** - Parent page ID for creating test pages
- **`test_page_synced_blocks`** - Page for testing synced block compatibility
- **`test_page_numbered_lists`** - Page with numbered list items
- **`test_page_complex_content`** - Page with diverse content types
- **`test_page_ids_for_ingestion`** - List of all test page IDs

### Cleanup

All test pages are automatically archived after the test session completes. If cleanup fails (e.g., due to network issues), you can manually archive or delete pages titled:

- "Test Page - Synced Blocks (Auto-generated by pytest)"
- "Test Page - Numbered Lists (Auto-generated by pytest)"
- "Test Page - Complex Content (Auto-generated by pytest)"

## What Gets Tested

### 1. SyncBlock Monkeypatch

**Test**: `test_notion_synced_blocks_ingestion`

- Creates a page with synced blocks
- Validates that ingestion succeeds without `KeyError: 'children'`
- Confirms "Applied monkeypatch to SyncBlock" log message

### 2. NumberedListItem Monkeypatch

**Test**: `test_notion_numbered_lists_ingestion`

- Creates a page with numbered list items
- Validates that new Notion API fields are handled (`list_start_index`, `list_format`)
- Confirms "Applied monkeypatch to NumberedListItem" log message

### 3. Full Ingestion

**Test**: `test_notion_full_ingestion`

- Ingests all test pages together
- Validates all monkeypatches are applied
- Confirms successful ingestion of multiple pages

### 4. Credential Validation

**Test**: `test_notion_bedrock_credential_warning`

- Tests AWS Bedrock embedding config without credentials
- Validates early warning message is displayed
- Confirms documents are ingested despite embedding failures (non-blocking design)

**Test**: `test_notion_cohere_credential_warning`

- Tests Cohere embedding config with invalid credentials
- Validates credential error detection and logging
- Confirms documents are ingested without embeddings

### 5. Test Connection

**Test**: `test_notion_test_connection`

- Validates the `test_connection` capability
- Tests basic connectivity and page access reporting

## Troubleshooting

### Tests are skipped

**Cause**: Environment variables not set

**Solution**: Export `NOTION_API_KEY` and `NOTION_TEST_PARENT_PAGE_ID`

### "Page not found" or "Unauthorized" errors

**Cause**: Test parent page not shared with integration

**Solution**: Share the test parent page with your Notion integration

### Embedding tests fail unexpectedly

**Cause**: Real credentials provided when tests expect failures

**Solution**: Tests for credential warnings use invalid credentials intentionally. These tests should pass even without real AWS/Cohere credentials.

### "Too Many Requests" errors

**Cause**: Notion API rate limiting (3 req/sec for paid, 1 req/sec for free)

**Solution**: Tests create minimal pages and run sequentially. If you hit rate limits, wait a few seconds and re-run.

## CI/CD Integration

### GitHub Actions Example

```yaml
- name: Run Notion Integration Tests
  env:
    NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
    NOTION_TEST_PARENT_PAGE_ID: ${{ secrets.NOTION_TEST_PARENT_PAGE_ID }}
  run: |
    cd metadata-ingestion
    ../gradlew :metadata-ingestion:testQuick -PtestFile=tests/integration/notion/test_notion_integration.py
```

### Important Notes for CI

- Store `NOTION_API_KEY` as a secret (never commit to repo)
- Use a dedicated Notion workspace for CI testing
- Consider rate limits if running tests frequently
- Tests will automatically skip if credentials are not provided

## Manual Testing with Synced Blocks

**Note**: The Notion API does not currently support creating synced blocks programmatically. To test synced block handling:

1. Manually create a page in your test workspace
2. Add an "Original synced block" with some content
3. Reference that synced block elsewhere on the page or another page
4. Share the page with your test integration
5. Add the page ID to the test configuration

The test will validate that both the original and reference synced blocks are ingested correctly.

## Related Documentation

- [Notion API Documentation](https://developers.notion.com/)
- [DataHub Notion Connector](../../../src/datahub/ingestion/source/notion/notion_source.py)
- [Integration Test Patterns](../../README.md)
