# docker-compose.yml
version: '3.8'
services:
  test-timescaledb:
    container_name: "test-timescaledb"
    hostname: timescaledb
    image: timescale/timescaledb:2.21.2-pg15
    environment:
      POSTGRES_USER: "tsdbuser"
      POSTGRES_PASSWORD: "tsdbpass"
      POSTGRES_DB: "tsdb"
      POSTGRES_INITDB_ARGS: "--auth-local=trust --auth-host=md5"
      POSTGRES_HOST_AUTH_METHOD: "trust"
      PGUSER: "tsdbuser"
      PGPASSWORD: "tsdbpass"
      PGDATABASE: "tsdb"
    ports:
      - '55432:5432'
    volumes:
      - ./setup:/setup
      - ./setup/setup.sql:/docker-entrypoint-initdb.d/01-setup.sql
      - ./setup/timescale-setup.sql:/docker-entrypoint-initdb.d/02-timescale-setup.sql
    command:
      - postgres
      - -c
      - shared_preload_libraries=timescaledb
      - -c
      - timescaledb.telemetry_level=off
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U tsdbuser -d tsdb"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s