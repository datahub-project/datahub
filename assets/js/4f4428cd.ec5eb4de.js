"use strict";(self.webpackChunkdocs_website=self.webpackChunkdocs_website||[]).push([[96830],{15680:(e,t,n)=>{n.d(t,{xA:()=>p,yg:()=>m});var l=n(96540);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);t&&(l=l.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,l)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,l,a=function(e,t){if(null==e)return{};var n,l,a={},r=Object.keys(e);for(l=0;l<r.length;l++)n=r[l],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(l=0;l<r.length;l++)n=r[l],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var s=l.createContext({}),u=function(e){var t=l.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},p=function(e){var t=u(e.components);return l.createElement(s.Provider,{value:t},e.children)},g="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return l.createElement(l.Fragment,{},t)}},c=l.forwardRef((function(e,t){var n=e.components,a=e.mdxType,r=e.originalType,s=e.parentName,p=o(e,["components","mdxType","originalType","parentName"]),g=u(n),c=a,m=g["".concat(s,".").concat(c)]||g[c]||d[c]||r;return n?l.createElement(m,i(i({ref:t},p),{},{components:n})):l.createElement(m,i({ref:t},p))}));function m(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var r=n.length,i=new Array(r);i[0]=c;var o={};for(var s in t)hasOwnProperty.call(t,s)&&(o[s]=t[s]);o.originalType=e,o[g]="string"==typeof e?e:a,i[1]=o;for(var u=2;u<r;u++)i[u]=n[u];return l.createElement.apply(null,i)}return l.createElement.apply(null,n)}c.displayName="MDXCreateElement"},76846:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>p,contentTitle:()=>s,default:()=>m,frontMatter:()=>o,metadata:()=>u,toc:()=>g});n(96540);var l=n(15680);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);t&&(l=l.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,l)}return n}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}function i(e,t){if(null==e)return{};var n,l,a=function(e,t){if(null==e)return{};var n,l,a={},r=Object.keys(e);for(l=0;l<r.length;l++)n=r[l],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(l=0;l<r.length;l++)n=r[l],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}const o={title:"Docker Test Guide",slug:"/metadata-ingestion-modules/airflow-plugin/docker_test_guide",custom_edit_url:"https://github.com/datahub-project/datahub/blob/master/metadata-ingestion-modules/airflow-plugin/DOCKER_TEST_GUIDE.md"},s="Docker Test Guide",u={unversionedId:"metadata-ingestion-modules/airflow-plugin/DOCKER_TEST_GUIDE",id:"metadata-ingestion-modules/airflow-plugin/DOCKER_TEST_GUIDE",title:"Docker Test Guide",description:"This guide explains how to run Airflow plugin tests in Docker with automatic volume mounts for source code and golden files.",source:"@site/genDocs/metadata-ingestion-modules/airflow-plugin/DOCKER_TEST_GUIDE.md",sourceDirName:"metadata-ingestion-modules/airflow-plugin",slug:"/metadata-ingestion-modules/airflow-plugin/docker_test_guide",permalink:"/docs/metadata-ingestion-modules/airflow-plugin/docker_test_guide",draft:!1,editUrl:"https://github.com/datahub-project/datahub/blob/master/metadata-ingestion-modules/airflow-plugin/DOCKER_TEST_GUIDE.md",tags:[],version:"current",frontMatter:{title:"Docker Test Guide",slug:"/metadata-ingestion-modules/airflow-plugin/docker_test_guide",custom_edit_url:"https://github.com/datahub-project/datahub/blob/master/metadata-ingestion-modules/airflow-plugin/DOCKER_TEST_GUIDE.md"}},p={},g=[{value:"Overview",id:"overview",level:2},{value:"Quick Start",id:"quick-start",level:2},{value:"Option 1: Wrapper Script (Easiest)",id:"option-1-wrapper-script-easiest",level:3},{value:"Option 2: Docker Compose (Recommended)",id:"option-2-docker-compose-recommended",level:3},{value:"Option 3: Docker CLI (Most Control)",id:"option-3-docker-cli-most-control",level:3},{value:"Building the Image",id:"building-the-image",level:2},{value:"Default Build (Python 3.11, Airflow 3.1)",id:"default-build-python-311-airflow-31",level:3},{value:"Custom Python Version",id:"custom-python-version",level:3},{value:"Custom Default Tox Environment",id:"custom-default-tox-environment",level:3},{value:"Running Tests",id:"running-tests",level:2},{value:"Available Tox Environments",id:"available-tox-environments",level:3},{value:"Run All Tests",id:"run-all-tests",level:3},{value:"Run Specific Test File",id:"run-specific-test-file",level:3},{value:"Run Specific Test Function",id:"run-specific-test-function",level:3},{value:"Run Tests Matching Pattern",id:"run-tests-matching-pattern",level:3},{value:"Run with Additional pytest Options",id:"run-with-additional-pytest-options",level:3},{value:"Updating Golden Files",id:"updating-golden-files",level:2},{value:"With Wrapper Script (Easiest)",id:"with-wrapper-script-easiest",level:3},{value:"With Docker Compose",id:"with-docker-compose",level:3},{value:"With Docker CLI (Manual Volume Mount)",id:"with-docker-cli-manual-volume-mount",level:3},{value:"Advanced Usage",id:"advanced-usage",level:2},{value:"Interactive Shell",id:"interactive-shell",level:3},{value:"Run Tox Directly (Without Entrypoint)",id:"run-tox-directly-without-entrypoint",level:3},{value:"Volume Mount for Development",id:"volume-mount-for-development",level:3},{value:"Override Default Tox Environment",id:"override-default-tox-environment",level:3},{value:"Testing Different Airflow Versions",id:"testing-different-airflow-versions",level:2},{value:"Airflow 2.7",id:"airflow-27",level:3},{value:"Airflow 2.9",id:"airflow-29",level:3},{value:"Airflow 3.1",id:"airflow-31",level:3},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"Build Context Issues",id:"build-context-issues",level:3},{value:"Tox Cache Issues",id:"tox-cache-issues",level:3},{value:"Python Version Mismatch",id:"python-version-mismatch",level:3},{value:"Permission Issues with Golden Files",id:"permission-issues-with-golden-files",level:3},{value:"Out of Memory",id:"out-of-memory",level:3},{value:"CI/CD Integration",id:"cicd-integration",level:2},{value:"GitHub Actions Example",id:"github-actions-example",level:3},{value:"GitLab CI Example",id:"gitlab-ci-example",level:3},{value:"How It Works",id:"how-it-works",level:2},{value:"Tox Configuration",id:"tox-configuration",level:3},{value:"Entrypoint Logic",id:"entrypoint-logic",level:3},{value:"Comparison: Docker vs Local Tox",id:"comparison-docker-vs-local-tox",level:2},{value:"Best Practices",id:"best-practices",level:2},{value:"Support",id:"support",level:2}],d={toc:g},c="wrapper";function m(e){var{components:t}=e,n=i(e,["components"]);return(0,l.yg)(c,r(function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},l=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(l=l.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),l.forEach((function(t){a(e,t,n[t])}))}return e}({},d,n),{components:t,mdxType:"MDXLayout"}),(0,l.yg)("h1",{id:"docker-test-guide"},"Docker Test Guide"),(0,l.yg)("p",null,"This guide explains how to run Airflow plugin tests in Docker with automatic volume mounts for source code and golden files."),(0,l.yg)("h2",{id:"overview"},"Overview"),(0,l.yg)("p",null,"The Docker test environment uses ",(0,l.yg)("strong",{parentName:"p"},"tox")," to manage all dependencies:"),(0,l.yg)("ul",null,(0,l.yg)("li",{parentName:"ul"},"\u2705 Airflow (multiple versions: 2.7, 2.8, 2.9, 2.10, 3.1)"),(0,l.yg)("li",{parentName:"ul"},"\u2705 Airflow constraints files (for reproducible builds)"),(0,l.yg)("li",{parentName:"ul"},"\u2705 Provider packages (for Airflow 3.x)"),(0,l.yg)("li",{parentName:"ul"},"\u2705 All test dependencies"),(0,l.yg)("li",{parentName:"ul"},"\u2705 ",(0,l.yg)("strong",{parentName:"li"},"Automatic volume mounts")," for source code and golden files")),(0,l.yg)("p",null,(0,l.yg)("strong",{parentName:"p"},"Three ways to run tests:")),(0,l.yg)("ol",null,(0,l.yg)("li",{parentName:"ol"},(0,l.yg)("strong",{parentName:"li"},"Wrapper Script")," (easiest) - ",(0,l.yg)("inlineCode",{parentName:"li"},"./run-tests.sh")),(0,l.yg)("li",{parentName:"ol"},(0,l.yg)("strong",{parentName:"li"},"Docker Compose")," (recommended for CI/CD)"),(0,l.yg)("li",{parentName:"ol"},(0,l.yg)("strong",{parentName:"li"},"Docker CLI")," (most control)")),(0,l.yg)("h2",{id:"quick-start"},"Quick Start"),(0,l.yg)("h3",{id:"option-1-wrapper-script-easiest"},"Option 1: Wrapper Script (Easiest)"),(0,l.yg)("p",null,"The wrapper script automatically handles volume mounts and permissions:"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-bash"},"cd metadata-ingestion-modules/airflow-plugin\n\n# Run all tests with Airflow 3.1 (default)\n./run-tests.sh\n\n# Run tests with Airflow 2.9\n./run-tests.sh py311-airflow29\n\n# Run specific test\n./run-tests.sh py311-airflow31 -- tests/integration/test_plugin.py::test_v2_basic_dag -v\n\n# Update golden files (automatically mounted!)\n./run-tests.sh py311-airflow31 -- --update-golden-files\n\n# Rebuild Docker image before running\nREBUILD=true ./run-tests.sh\n")),(0,l.yg)("p",null,(0,l.yg)("strong",{parentName:"p"},"Benefits:")),(0,l.yg)("ul",null,(0,l.yg)("li",{parentName:"ul"},"\u2705 Automatic volume mounts (source code + golden files)"),(0,l.yg)("li",{parentName:"ul"},"\u2705 Correct user permissions (no root-owned files)"),(0,l.yg)("li",{parentName:"ul"},"\u2705 Auto-builds image if needed"),(0,l.yg)("li",{parentName:"ul"},"\u2705 Simple, easy-to-remember commands")),(0,l.yg)("h3",{id:"option-2-docker-compose-recommended"},"Option 2: Docker Compose (Recommended)"),(0,l.yg)("p",null,"Docker Compose automatically mounts volumes and caches tox environments:"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-bash"},"cd metadata-ingestion-modules/airflow-plugin\n\n# Run all tests with Airflow 3.1 (default)\ndocker-compose -f docker-compose.test.yml run --rm airflow-plugin-test\n\n# Run tests with Airflow 2.9\ndocker-compose -f docker-compose.test.yml run --rm airflow-plugin-test py311-airflow29\n\n# Run specific test\ndocker-compose -f docker-compose.test.yml run --rm airflow-plugin-test py311-airflow31 -- tests/integration/test_plugin.py::test_v2_basic_dag -v\n\n# Update golden files (automatically mounted!)\ndocker-compose -f docker-compose.test.yml run --rm airflow-plugin-test py311-airflow31 -- --update-golden-files\n\n# Build the image\ndocker-compose -f docker-compose.test.yml build\n")),(0,l.yg)("p",null,(0,l.yg)("strong",{parentName:"p"},"Benefits:")),(0,l.yg)("ul",null,(0,l.yg)("li",{parentName:"ul"},"\u2705 Automatic volume mounts (source code + golden files)"),(0,l.yg)("li",{parentName:"ul"},"\u2705 Persistent tox cache (faster subsequent runs)"),(0,l.yg)("li",{parentName:"ul"},"\u2705 Easy to customize via docker-compose.test.yml"),(0,l.yg)("li",{parentName:"ul"},"\u2705 Great for CI/CD")),(0,l.yg)("h3",{id:"option-3-docker-cli-most-control"},"Option 3: Docker CLI (Most Control)"),(0,l.yg)("p",null,"If you need full control or don't want the wrapper:"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-bash"},"# Build from repository root\ncd /path/to/datahub\ndocker build -f metadata-ingestion-modules/airflow-plugin/Dockerfile.test -t airflow-plugin-test .\n\n# Run all tests with Airflow 3.1 (default)\ndocker run --rm airflow-plugin-test\n\n# Run tests with Airflow 2.9\ndocker run --rm airflow-plugin-test py311-airflow29\n\n# Run specific test\ndocker run --rm airflow-plugin-test py311-airflow31 -- tests/integration/test_plugin.py::test_v2_basic_dag -v\n\n# Update golden files (manual volume mount)\ndocker run --rm \\\n  -v $(pwd)/metadata-ingestion-modules/airflow-plugin:/app/metadata-ingestion-modules/airflow-plugin \\\n  airflow-plugin-test py311-airflow31 -- --update-golden-files\n")),(0,l.yg)("h2",{id:"building-the-image"},"Building the Image"),(0,l.yg)("h3",{id:"default-build-python-311-airflow-31"},"Default Build (Python 3.11, Airflow 3.1)"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-bash"},"# Must be run from repository root\ndocker build -f metadata-ingestion-modules/airflow-plugin/Dockerfile.test -t airflow-plugin-test .\n")),(0,l.yg)("h3",{id:"custom-python-version"},"Custom Python Version"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-bash"},"docker build -f metadata-ingestion-modules/airflow-plugin/Dockerfile.test \\\n  --build-arg PYTHON_VERSION=3.10 \\\n  -t airflow-plugin-test:py310 .\n")),(0,l.yg)("h3",{id:"custom-default-tox-environment"},"Custom Default Tox Environment"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-bash"},"docker build -f metadata-ingestion-modules/airflow-plugin/Dockerfile.test \\\n  --build-arg TOX_ENV=py311-airflow29 \\\n  -t airflow-plugin-test:af29 .\n")),(0,l.yg)("h2",{id:"running-tests"},"Running Tests"),(0,l.yg)("h3",{id:"available-tox-environments"},"Available Tox Environments"),(0,l.yg)("p",null,"From ",(0,l.yg)("inlineCode",{parentName:"p"},"tox.ini"),":"),(0,l.yg)("ul",null,(0,l.yg)("li",{parentName:"ul"},(0,l.yg)("inlineCode",{parentName:"li"},"py39-airflow27")," - Python 3.9, Airflow 2.7"),(0,l.yg)("li",{parentName:"ul"},(0,l.yg)("inlineCode",{parentName:"li"},"py310-airflow27")," - Python 3.10, Airflow 2.7"),(0,l.yg)("li",{parentName:"ul"},(0,l.yg)("inlineCode",{parentName:"li"},"py310-airflow28")," - Python 3.10, Airflow 2.8"),(0,l.yg)("li",{parentName:"ul"},(0,l.yg)("inlineCode",{parentName:"li"},"py311-airflow29")," - Python 3.11, Airflow 2.9"),(0,l.yg)("li",{parentName:"ul"},(0,l.yg)("inlineCode",{parentName:"li"},"py311-airflow210")," - Python 3.11, Airflow 2.10"),(0,l.yg)("li",{parentName:"ul"},(0,l.yg)("inlineCode",{parentName:"li"},"py311-airflow31")," - Python 3.11, Airflow 3.1 (default)")),(0,l.yg)("h3",{id:"run-all-tests"},"Run All Tests"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-bash"},"# With default environment (py311-airflow31)\ndocker run airflow-plugin-test\n\n# With specific environment\ndocker run airflow-plugin-test py311-airflow29\n")),(0,l.yg)("h3",{id:"run-specific-test-file"},"Run Specific Test File"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-bash"},"docker run airflow-plugin-test py311-airflow31 -- tests/integration/test_plugin.py -v\n")),(0,l.yg)("h3",{id:"run-specific-test-function"},"Run Specific Test Function"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-bash"},"docker run airflow-plugin-test py311-airflow31 -- tests/integration/test_plugin.py::test_v2_snowflake_operator_airflow3 -v\n")),(0,l.yg)("h3",{id:"run-tests-matching-pattern"},"Run Tests Matching Pattern"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-bash"},'docker run airflow-plugin-test py311-airflow31 -- -k "snowflake" -v\n')),(0,l.yg)("h3",{id:"run-with-additional-pytest-options"},"Run with Additional pytest Options"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-bash"},"# Stop on first failure\ndocker run airflow-plugin-test py311-airflow31 -- -x\n\n# Show local variables in tracebacks\ndocker run airflow-plugin-test py311-airflow31 -- -l\n\n# Verbose output\ndocker run airflow-plugin-test py311-airflow31 -- -vv\n\n# Show captured output\ndocker run airflow-plugin-test py311-airflow31 -- -s\n")),(0,l.yg)("h2",{id:"updating-golden-files"},"Updating Golden Files"),(0,l.yg)("p",null,"Golden files are ",(0,l.yg)("strong",{parentName:"p"},"automatically mounted")," when using the wrapper script or docker-compose!"),(0,l.yg)("h3",{id:"with-wrapper-script-easiest"},"With Wrapper Script (Easiest)"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-bash"},"# Update all golden files\n./run-tests.sh py311-airflow31 -- --update-golden-files\n\n# Update golden files for specific test\n./run-tests.sh py311-airflow31 -- tests/integration/test_plugin.py::test_v2_snowflake_operator_airflow3 --update-golden-files\n")),(0,l.yg)("p",null,(0,l.yg)("strong",{parentName:"p"},"That's it!")," Golden files are automatically written to your local filesystem."),(0,l.yg)("h3",{id:"with-docker-compose"},"With Docker Compose"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-bash"},"# Update all golden files\ndocker-compose -f docker-compose.test.yml run --rm airflow-plugin-test py311-airflow31 -- --update-golden-files\n\n# Update golden files for specific test\ndocker-compose -f docker-compose.test.yml run --rm airflow-plugin-test py311-airflow31 -- tests/integration/test_plugin.py::test_v2_snowflake_operator_airflow3 --update-golden-files\n")),(0,l.yg)("h3",{id:"with-docker-cli-manual-volume-mount"},"With Docker CLI (Manual Volume Mount)"),(0,l.yg)("p",null,"If you're using raw Docker commands, you need to mount the golden files directory:"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-bash"},"# From repository root\ndocker run --rm \\\n  -v $(pwd)/metadata-ingestion-modules/airflow-plugin:/app/metadata-ingestion-modules/airflow-plugin \\\n  airflow-plugin-test py311-airflow31 -- --update-golden-files\n\n# Or just mount the goldens directory\ndocker run --rm \\\n  -v $(pwd)/metadata-ingestion-modules/airflow-plugin/tests/integration/goldens:/app/metadata-ingestion-modules/airflow-plugin/tests/integration/goldens \\\n  airflow-plugin-test py311-airflow31 -- --update-golden-files\n")),(0,l.yg)("h2",{id:"advanced-usage"},"Advanced Usage"),(0,l.yg)("h3",{id:"interactive-shell"},"Interactive Shell"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-bash"},"docker run -it --entrypoint /bin/bash airflow-plugin-test\n\n# Inside container:\ncd metadata-ingestion-modules/airflow-plugin\ntox -e py311-airflow31 -- -v\n")),(0,l.yg)("h3",{id:"run-tox-directly-without-entrypoint"},"Run Tox Directly (Without Entrypoint)"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-bash"},"docker run --entrypoint tox airflow-plugin-test -e py311-airflow29 -- tests/integration/ -v\n")),(0,l.yg)("h3",{id:"volume-mount-for-development"},"Volume Mount for Development"),(0,l.yg)("p",null,"Mount your local code for live editing:"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-bash"},"docker run -v $(pwd):/app airflow-plugin-test py311-airflow31 -- tests/integration/ -v\n")),(0,l.yg)("p",null,(0,l.yg)("strong",{parentName:"p"},"Note:")," You may need to rebuild the tox environment after code changes:"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-bash"},"docker run -v $(pwd):/app airflow-plugin-test py311-airflow31 --recreate\n")),(0,l.yg)("h3",{id:"override-default-tox-environment"},"Override Default Tox Environment"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-bash"},"# Set different default at runtime\ndocker run -e TOX_ENV=py311-airflow29 airflow-plugin-test\n")),(0,l.yg)("h2",{id:"testing-different-airflow-versions"},"Testing Different Airflow Versions"),(0,l.yg)("h3",{id:"airflow-27"},"Airflow 2.7"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-bash"},"docker run airflow-plugin-test py310-airflow27\n")),(0,l.yg)("h3",{id:"airflow-29"},"Airflow 2.9"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-bash"},"docker run airflow-plugin-test py311-airflow29\n")),(0,l.yg)("h3",{id:"airflow-31"},"Airflow 3.1"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-bash"},"docker run airflow-plugin-test py311-airflow31\n")),(0,l.yg)("h2",{id:"troubleshooting"},"Troubleshooting"),(0,l.yg)("h3",{id:"build-context-issues"},"Build Context Issues"),(0,l.yg)("p",null,"The Dockerfile must be run from the repository root because it needs access to ",(0,l.yg)("inlineCode",{parentName:"p"},"metadata-ingestion"),":"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-bash"},"# \u2705 Correct\ncd /path/to/datahub\ndocker build -f metadata-ingestion-modules/airflow-plugin/Dockerfile.test -t airflow-plugin-test .\n\n# \u274c Wrong (will fail - can't find ../../metadata-ingestion)\ncd /path/to/datahub/metadata-ingestion-modules/airflow-plugin\ndocker build -f Dockerfile.test -t airflow-plugin-test .\n")),(0,l.yg)("h3",{id:"tox-cache-issues"},"Tox Cache Issues"),(0,l.yg)("p",null,"If you encounter stale dependencies:"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-bash"},"# Rebuild tox environment\ndocker run airflow-plugin-test py311-airflow31 --recreate\n\n# Or rebuild Docker image with no cache\ndocker build --no-cache -f metadata-ingestion-modules/airflow-plugin/Dockerfile.test -t airflow-plugin-test .\n")),(0,l.yg)("h3",{id:"python-version-mismatch"},"Python Version Mismatch"),(0,l.yg)("p",null,"Ensure the Python version in the Docker build matches the tox environment:"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-bash"},"# For py310-* environments\ndocker build --build-arg PYTHON_VERSION=3.10 \\\n  -f metadata-ingestion-modules/airflow-plugin/Dockerfile.test \\\n  -t airflow-plugin-test:py310 .\n\ndocker run airflow-plugin-test:py310 py310-airflow28\n")),(0,l.yg)("h3",{id:"permission-issues-with-golden-files"},"Permission Issues with Golden Files"),(0,l.yg)("p",null,"When using volume mounts:"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-bash"},"# Run with current user's UID/GID\ndocker run --user $(id -u):$(id -g) \\\n  -v $(pwd)/metadata-ingestion-modules/airflow-plugin/tests/integration/goldens:/app/metadata-ingestion-modules/airflow-plugin/tests/integration/goldens \\\n  airflow-plugin-test py311-airflow31 -- --update-golden-files\n")),(0,l.yg)("h3",{id:"out-of-memory"},"Out of Memory"),(0,l.yg)("p",null,"Tox may use significant memory when building environments:"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-bash"},"docker run --memory=4g airflow-plugin-test\n")),(0,l.yg)("h2",{id:"cicd-integration"},"CI/CD Integration"),(0,l.yg)("h3",{id:"github-actions-example"},"GitHub Actions Example"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-yaml"},"name: Test Airflow Plugin\non: [push, pull_request]\n\njobs:\n  test:\n    runs-on: ubuntu-latest\n    strategy:\n      matrix:\n        tox-env:\n          - py310-airflow27\n          - py310-airflow28\n          - py311-airflow29\n          - py311-airflow210\n          - py311-airflow31\n\n    steps:\n      - uses: actions/checkout@v3\n\n      - name: Build test image\n        run: |\n          docker build -f metadata-ingestion-modules/airflow-plugin/Dockerfile.test \\\n            -t airflow-plugin-test .\n\n      - name: Run tests\n        run: docker run airflow-plugin-test ${{ matrix.tox-env }}\n")),(0,l.yg)("h3",{id:"gitlab-ci-example"},"GitLab CI Example"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-yaml"},"test:\n  image: docker:latest\n  services:\n    - docker:dind\n  script:\n    - docker build -f metadata-ingestion-modules/airflow-plugin/Dockerfile.test -t airflow-plugin-test .\n    - docker run airflow-plugin-test $TOX_ENV\n  parallel:\n    matrix:\n      - TOX_ENV:\n          - py310-airflow27\n          - py310-airflow28\n          - py311-airflow29\n          - py311-airflow31\n")),(0,l.yg)("h2",{id:"how-it-works"},"How It Works"),(0,l.yg)("h3",{id:"tox-configuration"},"Tox Configuration"),(0,l.yg)("p",null,"The ",(0,l.yg)("inlineCode",{parentName:"p"},"tox.ini")," file defines all test environments with:"),(0,l.yg)("ul",null,(0,l.yg)("li",{parentName:"ul"},"Airflow version constraints"),(0,l.yg)("li",{parentName:"ul"},"Official Airflow constraints files for reproducible builds"),(0,l.yg)("li",{parentName:"ul"},"Provider packages for Airflow 3.x"),(0,l.yg)("li",{parentName:"ul"},"All necessary dependencies")),(0,l.yg)("h3",{id:"entrypoint-logic"},"Entrypoint Logic"),(0,l.yg)("p",null,"The entrypoint script intelligently routes commands:"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-bash"},"# No args \u2192 run default tox environment\ndocker run airflow-plugin-test\n# Executes: tox -e $TOX_ENV\n\n# Tox env specified \u2192 run that environment\ndocker run airflow-plugin-test py311-airflow29\n# Executes: tox -e py311-airflow29\n\n# Other args \u2192 pass to pytest via default environment\ndocker run airflow-plugin-test -- -k snowflake -v\n# Executes: tox -e $TOX_ENV -- -k snowflake -v\n\n# Tox env + pytest args\ndocker run airflow-plugin-test py311-airflow31 -- tests/integration/test_plugin.py -v\n# Executes: tox -e py311-airflow31 -- tests/integration/test_plugin.py -v\n")),(0,l.yg)("h2",{id:"comparison-docker-vs-local-tox"},"Comparison: Docker vs Local Tox"),(0,l.yg)("table",null,(0,l.yg)("thead",{parentName:"table"},(0,l.yg)("tr",{parentName:"thead"},(0,l.yg)("th",{parentName:"tr",align:null},"Aspect"),(0,l.yg)("th",{parentName:"tr",align:null},"Docker"),(0,l.yg)("th",{parentName:"tr",align:null},"Local Tox"))),(0,l.yg)("tbody",{parentName:"table"},(0,l.yg)("tr",{parentName:"tbody"},(0,l.yg)("td",{parentName:"tr",align:null},(0,l.yg)("strong",{parentName:"td"},"Setup")),(0,l.yg)("td",{parentName:"tr",align:null},"Build once, run anywhere"),(0,l.yg)("td",{parentName:"tr",align:null},"Requires local Python setup")),(0,l.yg)("tr",{parentName:"tbody"},(0,l.yg)("td",{parentName:"tr",align:null},(0,l.yg)("strong",{parentName:"td"},"Reproducibility")),(0,l.yg)("td",{parentName:"tr",align:null},"Guaranteed (same OS, packages)"),(0,l.yg)("td",{parentName:"tr",align:null},"Varies by local environment")),(0,l.yg)("tr",{parentName:"tbody"},(0,l.yg)("td",{parentName:"tr",align:null},(0,l.yg)("strong",{parentName:"td"},"CI/CD")),(0,l.yg)("td",{parentName:"tr",align:null},"Native support"),(0,l.yg)("td",{parentName:"tr",align:null},"Needs Python pre-installed")),(0,l.yg)("tr",{parentName:"tbody"},(0,l.yg)("td",{parentName:"tr",align:null},(0,l.yg)("strong",{parentName:"td"},"Speed (first run)")),(0,l.yg)("td",{parentName:"tr",align:null},"Slower (Docker build)"),(0,l.yg)("td",{parentName:"tr",align:null},"Slower (tox setup)")),(0,l.yg)("tr",{parentName:"tbody"},(0,l.yg)("td",{parentName:"tr",align:null},(0,l.yg)("strong",{parentName:"td"},"Speed (subsequent)")),(0,l.yg)("td",{parentName:"tr",align:null},"Fast if cached"),(0,l.yg)("td",{parentName:"tr",align:null},"Fast if cached")),(0,l.yg)("tr",{parentName:"tbody"},(0,l.yg)("td",{parentName:"tr",align:null},(0,l.yg)("strong",{parentName:"td"},"Disk Usage")),(0,l.yg)("td",{parentName:"tr",align:null},"Higher (Docker layers)"),(0,l.yg)("td",{parentName:"tr",align:null},"Lower")),(0,l.yg)("tr",{parentName:"tbody"},(0,l.yg)("td",{parentName:"tr",align:null},(0,l.yg)("strong",{parentName:"td"},"Isolation")),(0,l.yg)("td",{parentName:"tr",align:null},"Complete (OS level)"),(0,l.yg)("td",{parentName:"tr",align:null},"Python environment only")),(0,l.yg)("tr",{parentName:"tbody"},(0,l.yg)("td",{parentName:"tr",align:null},(0,l.yg)("strong",{parentName:"td"},"Golden Files")),(0,l.yg)("td",{parentName:"tr",align:null},"Volume mounts needed"),(0,l.yg)("td",{parentName:"tr",align:null},"Direct access")))),(0,l.yg)("p",null,(0,l.yg)("strong",{parentName:"p"},"Use Docker for:")),(0,l.yg)("ul",null,(0,l.yg)("li",{parentName:"ul"},"CI/CD pipelines"),(0,l.yg)("li",{parentName:"ul"},"Consistent cross-platform testing"),(0,l.yg)("li",{parentName:"ul"},"Complete environment isolation"),(0,l.yg)("li",{parentName:"ul"},"Sharing test environments")),(0,l.yg)("p",null,(0,l.yg)("strong",{parentName:"p"},"Use Local Tox for:")),(0,l.yg)("ul",null,(0,l.yg)("li",{parentName:"ul"},"Day-to-day development"),(0,l.yg)("li",{parentName:"ul"},"Faster iteration"),(0,l.yg)("li",{parentName:"ul"},"Direct file access"),(0,l.yg)("li",{parentName:"ul"},"Debugging")),(0,l.yg)("h2",{id:"best-practices"},"Best Practices"),(0,l.yg)("ol",null,(0,l.yg)("li",{parentName:"ol"},(0,l.yg)("strong",{parentName:"li"},"Always build from repository root")," - The Dockerfile needs access to ",(0,l.yg)("inlineCode",{parentName:"li"},"metadata-ingestion")),(0,l.yg)("li",{parentName:"ol"},(0,l.yg)("strong",{parentName:"li"},"Use volume mounts for golden files")," - Makes it easy to extract updated files"),(0,l.yg)("li",{parentName:"ol"},(0,l.yg)("strong",{parentName:"li"},"Match Python versions")," - Build arg should match tox environment (py310 \u2192 PYTHON_VERSION=3.10)"),(0,l.yg)("li",{parentName:"ol"},(0,l.yg)("strong",{parentName:"li"},"Cache Docker layers")," - Organize changes to maximize layer reuse"),(0,l.yg)("li",{parentName:"ol"},(0,l.yg)("strong",{parentName:"li"},"Clean up")," - Remove unused images: ",(0,l.yg)("inlineCode",{parentName:"li"},"docker image prune")),(0,l.yg)("li",{parentName:"ol"},(0,l.yg)("strong",{parentName:"li"},"Use specific tox envs")," - Don't rely on defaults in CI/CD")),(0,l.yg)("h2",{id:"support"},"Support"),(0,l.yg)("p",null,"For issues:"),(0,l.yg)("ul",null,(0,l.yg)("li",{parentName:"ul"},(0,l.yg)("strong",{parentName:"li"},"Tox configuration"),": See ",(0,l.yg)("inlineCode",{parentName:"li"},"tox.ini")," in the airflow-plugin directory"),(0,l.yg)("li",{parentName:"ul"},(0,l.yg)("strong",{parentName:"li"},"Docker logs"),": ",(0,l.yg)("inlineCode",{parentName:"li"},"docker logs <container-id>")),(0,l.yg)("li",{parentName:"ul"},(0,l.yg)("strong",{parentName:"li"},"Build output"),": ",(0,l.yg)("inlineCode",{parentName:"li"},"docker build --progress=plain")),(0,l.yg)("li",{parentName:"ul"},(0,l.yg)("strong",{parentName:"li"},"Interactive debugging"),": ",(0,l.yg)("inlineCode",{parentName:"li"},"docker run -it --entrypoint /bin/bash airflow-plugin-test"))))}m.isMDXComponent=!0}}]);