import { Remirror, useRemirror } from '@remirror/react';
import React, { useMemo } from 'react';
import { HelmetProvider } from 'react-helmet-async';
import { MemoryRouter } from 'react-router';
import { ItalicExtension, UnderlineExtension } from 'remirror/extensions';

import UserContextProvider from '@app/context/UserContextProvider';
import EntityRegistry from '@app/entity/EntityRegistry';
import { BusinessAttributeEntity } from '@app/entity/businessAttribute/BusinessAttributeEntity';
import { ChartEntity } from '@app/entity/chart/ChartEntity';
import { ContainerEntity } from '@app/entity/container/ContainerEntity';
import { DashboardEntity } from '@app/entity/dashboard/DashboardEntity';
import { DataFlowEntity } from '@app/entity/dataFlow/DataFlowEntity';
import { DataJobEntity } from '@app/entity/dataJob/DataJobEntity';
import { DataPlatformEntity } from '@app/entity/dataPlatform/DataPlatformEntity';
import { DataPlatformInstanceEntity } from '@app/entity/dataPlatformInstance/DataPlatformInstanceEntity';
import { DataProductEntity } from '@app/entity/dataProduct/DataProductEntity';
import { DatasetEntity } from '@app/entity/dataset/DatasetEntity';
import { DomainEntity } from '@app/entity/domain/DomainEntity';
import { GlossaryTermEntity } from '@app/entity/glossaryTerm/GlossaryTermEntity';
import { GroupEntity } from '@app/entity/group/Group';
import { MLFeatureTableEntity } from '@app/entity/mlFeatureTable/MLFeatureTableEntity';
import { MLModelEntity } from '@app/entity/mlModel/MLModelEntity';
import { MLModelGroupEntity } from '@app/entity/mlModelGroup/MLModelGroupEntity';
import { QueryEntity } from '@app/entity/query/QueryEntity';
import { SchemaFieldPropertiesEntity } from '@app/entity/schemaField/SchemaFieldPropertiesEntity';
import { StructuredPropertyEntity } from '@app/entity/structuredProperty/StructuredPropertyEntity';
import { TagEntity } from '@app/entity/tag/Tag';
import { UserEntity } from '@app/entity/user/User';
import { LineageExplorerContext } from '@app/lineage/utils/LineageExplorerContext';
import { CLIENT_AUTH_COOKIE } from '@conf/Global';
import AppConfigProvider from '@src/AppConfigProvider';
import CustomThemeProvider from '@src/CustomThemeProvider';
import { EntityRegistryContext } from '@src/entityRegistryContext';

type Props = {
    children: React.ReactNode;
    initialEntries?: string[];
};

export function getTestEntityRegistry() {
    const entityRegistry = new EntityRegistry();
    entityRegistry.register(new DatasetEntity());
    entityRegistry.register(new ChartEntity());
    entityRegistry.register(new DashboardEntity());
    entityRegistry.register(new UserEntity());
    entityRegistry.register(new GroupEntity());
    entityRegistry.register(new TagEntity());
    entityRegistry.register(new DataFlowEntity());
    entityRegistry.register(new DataJobEntity());
    entityRegistry.register(new GlossaryTermEntity());
    entityRegistry.register(new MLFeatureTableEntity());
    entityRegistry.register(new MLModelEntity());
    entityRegistry.register(new MLModelGroupEntity());
    entityRegistry.register(new DataPlatformEntity());
    entityRegistry.register(new ContainerEntity());
    entityRegistry.register(new BusinessAttributeEntity());
    entityRegistry.register(new SchemaFieldPropertiesEntity());
    entityRegistry.register(new DomainEntity());
    entityRegistry.register(new DataProductEntity());
    entityRegistry.register(new DataPlatformInstanceEntity());
    entityRegistry.register(new QueryEntity());
    entityRegistry.register(new SchemaFieldPropertiesEntity());
    entityRegistry.register(new StructuredPropertyEntity());
    return entityRegistry;
}

export default ({ children, initialEntries }: Props) => {
    const entityRegistry = useMemo(() => getTestEntityRegistry(), []);
    Object.defineProperty(window.document, 'cookie', {
        writable: true,
        value: `${CLIENT_AUTH_COOKIE}=urn:li:corpuser:2`,
    });
    vi.mock('js-cookie', () => ({ default: { get: () => 'urn:li:corpuser:2' } }));

    // mock remirror
    const extensions = () => [new ItalicExtension(), new UnderlineExtension()];
    const { manager, state } = useRemirror({
        extensions,
    });

    return (
        <HelmetProvider>
            <CustomThemeProvider>
                <MemoryRouter initialEntries={initialEntries}>
                    <EntityRegistryContext.Provider value={entityRegistry}>
                        <UserContextProvider>
                            <AppConfigProvider>
                                <Remirror manager={manager} state={state}>
                                    <LineageExplorerContext.Provider
                                        value={{
                                            expandTitles: false,
                                            showColumns: false,
                                            collapsedColumnsNodes: {},
                                            setCollapsedColumnsNodes: null,
                                            fineGrainedMap: {},
                                            selectedField: null,
                                            setSelectedField: () => {},
                                            highlightedEdges: [],
                                            setHighlightedEdges: () => {},
                                            visibleColumnsByUrn: {},
                                            setVisibleColumnsByUrn: () => {},
                                            columnsByUrn: {},
                                            setColumnsByUrn: () => {},
                                            refetchCenterNode: () => {},
                                        }}
                                    >
                                        {children}
                                    </LineageExplorerContext.Provider>
                                </Remirror>
                            </AppConfigProvider>
                        </UserContextProvider>
                    </EntityRegistryContext.Provider>
                </MemoryRouter>
            </CustomThemeProvider>
        </HelmetProvider>
    );
};
