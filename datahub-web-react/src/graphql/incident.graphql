# We cannot use entityPreview here because it will cause a circular dependency
fragment incidentLinkedAssetPreview on Entity {
    urn
    type
    ... on Dataset {
        name
        origin
        uri
        platform {
            ...platformFields
        }
        editableProperties {
            name
            description
        }
        platformNativeType
        properties {
            name
            description
            customProperties {
                key
                value
            }
        }
    }
    ... on Dashboard {
        urn
        type
        tool
        dashboardId
        properties {
            name
            description
            externalUrl
            access
            lastModified {
                time
            }
        }
        platform {
            ...platformFields
        }
    }
    ... on Chart {
        urn
        type
        tool
        chartId
        properties {
            name
            description
            externalUrl
            type
            access
            lastModified {
                time
            }
        }
        platform {
            ...platformFields
        }
    }
    ... on DataFlow {
        urn
        type
        orchestrator
        flowId
        cluster
        properties {
            name
            description
            project
        }
        platform {
            ...platformFields
        }
    }
    ... on MLFeatureTable {
        urn
        type
        name
        description
        featureTableProperties {
            description
            mlFeatures {
                urn
            }
            mlPrimaryKeys {
                urn
            }
        }
        platform {
            ...platformFields
        }
    }
    ... on MLModel {
        name
        description
        origin
        platform {
            ...platformFields
        }
        deprecation {
            ...deprecationFields
        }
    }
    ... on MLModelGroup {
        name
        origin
        description
        platform {
            ...platformFields
        }
        deprecation {
            ...deprecationFields
        }
    }
    ... on DataPlatform {
        ...nonConflictingPlatformFields
    }
}

fragment incidentFields on Incident {
    incidentType
    customType
    title
    description
    startedAt
    incidentStatus {
        state
        stage
        message
        lastUpdated {
            time
            actor
        }
    }
    source {
        type
        source {
            ...assertionDetails
        }
    }
    created {
        time
        actor
    }
    tags {
        ...globalTagsFields
    }
    priority
    assignees {
        ... on CorpUser {
            urn
            type
            username
            status
            properties {
                displayName
            }
        }
    }
    entity {
        ...incidentLinkedAssetPreview
    }
    linkedAssets: relationships(
        input: { types: ["IncidentOn"], direction: OUTGOING, start: 0, count: 1000, includeSoftDelete: false }
    ) {
        relationships {
            entity {
                ...incidentLinkedAssetPreview
            }
        }
    }
}

fragment incidentResultFields on EntityIncidentsResult {
    start
    count
    total
    incidents {
        urn
        type
        ...incidentFields
        # for backward compatibility
        status {
            state
            stage
            message
            lastUpdated {
                time
                actor
            }
        }
    }
}

fragment datasetSiblingIncidents on Dataset {
    siblings {
        isPrimary
        siblings {
            urn
            type
            ... on Dataset {
                incidents(start: $start, count: $count, state: $state) {
                    ...incidentResultFields
                }
            }
        }
    }
    siblingsSearch(input: { query: "*", count: 5 }) @skip(if: $skipSiblingsSearch) {
        count
        total
        searchResults {
            entity {
                urn
                type
                ... on Dataset {
                    incidents(start: $start, count: $count, state: $state) {
                        ...incidentResultFields
                    }
                }
            }
        }
    }
}

query getEntityIncidents(
    $urn: String!
    $start: Int!
    $count: Int!
    $state: IncidentState
    $skipSiblingsSearch: Boolean = false
) {
    entity(urn: $urn) {
        ... on Dataset {
            incidents(start: $start, count: $count, state: $state) {
                ...incidentResultFields
            }
            ...datasetSiblingIncidents
            privileges {
                canEditIncidents
            }
        }
        ... on DataJob {
            incidents(start: $start, count: $count, state: $state) {
                ...incidentResultFields
            }
            privileges {
                canEditIncidents
            }
        }
        ... on DataFlow {
            incidents(start: $start, count: $count, state: $state) {
                ...incidentResultFields
            }
            privileges {
                canEditIncidents
            }
        }
        ... on Dashboard {
            incidents(start: $start, count: $count, state: $state) {
                ...incidentResultFields
            }
            privileges {
                canEditIncidents
            }
        }
        ... on Chart {
            incidents(start: $start, count: $count, state: $state) {
                ...incidentResultFields
            }
            privileges {
                canEditIncidents
            }
        }
    }
}
