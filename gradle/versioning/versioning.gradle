import groovy.json.JsonSlurper
import org.apache.tools.ant.filters.ReplaceTokens

apply from: rootProject.file('gradle/versioning/cliVersion.gradle')

def detailedVersionString = "0.0.0-unknown-SNAPSHOT"
def inputFile = file("${rootProject.buildDir}/version.json")

ext {
  cliVersion = project.ext.cliVersion
  versionTag = "v${detailedVersionString}"
}

task readJsonData {
  if (inputFile.exists()) {
    def jsonSlurper = new JsonSlurper()
    def data = jsonSlurper.parse(inputFile)

    detailedVersionString = data.fullVersion
    cliVersion = data.cliVersion
    version = data.version
    versionTag = data.versionTag
  } else {
    println "git.properties JSON file not found: ${inputFile.path}"
  }
}

task printVersionDetails() {
  println("fullVersion=" + detailedVersionString)
  println("cliVersion=" + cliVersion)
  println("version=" +  version)
}

// Only configure processResources if a JVM plugin provides it
plugins.withType(JavaPlugin) {
    processResources {
        filter(ReplaceTokens, tokens:[fullVersion: detailedVersionString])
        filter(ReplaceTokens, tokens:[cliVersion: cliVersion])
    }
}

