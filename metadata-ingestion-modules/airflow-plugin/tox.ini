# tox (https://tox.readthedocs.io/) is a tool for running tests
# in multiple virtualenvs. This configuration file will run the
# test suite on all supported python versions. To use it, "pip install tox"
# and then run "tox" from this directory.

[tox]
envlist = py310-airflow27, py310-airflow28, py311-airflow29, py311-airflow210, py311-airflow210-provider, py311-airflow31

[testenv]
allowlist_externals = uv
package = wheel
install_command = uv pip install -v {opts} {packages}
use_develop = true
passenv =
    UV_CACHE_DIR
setenv =
    UV_CACHE_DIR = {env:UV_CACHE_DIR:/tmp/.uv-cache}

deps =
    # This should be kept in sync with the Github Actions matrix.
    # Install metadata-ingestion with sql-parser extra to ensure
    # datahub.sql_parsing modules can be imported for all Airflow versions
    -e ../../metadata-ingestion/[sql-parser]
    # Install mypy for type checking (needed in all environments)
    # Note: Airflow 2.9 and 2.10 constraint files pin mypy==1.9.0, so we use that version for compatibility
    airflow29,airflow210: mypy==1.9.0
    airflow27,airflow28,airflow31: mypy==1.17.1
    # Airflow version
    airflow27: apache-airflow~=2.7.0
    airflow28: apache-airflow~=2.8.0
    airflow29: apache-airflow~=2.9.0
    airflow210: apache-airflow~=2.10.0
    airflow210-provider: apache-airflow~=2.10.0
    airflow31: apache-airflow~=3.1.0

    # Respect the Airflow constraints files.
    py310-airflow27: -c https://raw.githubusercontent.com/apache/airflow/constraints-2.7.3/constraints-3.10.txt
    py310-airflow28: -c https://raw.githubusercontent.com/apache/airflow/constraints-2.8.1/constraints-3.10.txt
    py311-airflow29: -c https://raw.githubusercontent.com/apache/airflow/constraints-2.9.3/constraints-3.11.txt
    py311-airflow210: -c https://raw.githubusercontent.com/apache/airflow/constraints-2.10.3/constraints-3.11.txt
    # For airflow210-provider: Don't use constraint file as it pins apache-airflow-providers-openlineage==1.13.0
    # which requires Airflow 3.x. We'll install apache-airflow-providers-openlineage>=2.8.0 separately.
    # Note: We intentionally omit the constraint file for this environment to avoid the conflict.
    py311-airflow31: -c https://raw.githubusercontent.com/apache/airflow/constraints-3.1.0/constraints-3.11.txt

    # Provider packages for Airflow 3.x (providers are separate in Airflow 3)
    airflow31: apache-airflow-providers-google
    airflow31: apache-airflow-providers-amazon
    airflow31: apache-airflow-providers-snowflake
    airflow31: apache-airflow-providers-teradata
    # Install OpenLineage provider (required for airflow3/datahub_listener.py which imports openlineage.client.serde)
    airflow31: apache-airflow-providers-openlineage>=1.0.0
    # Install test dependencies for Airflow 3.x (pytest, pytest-cov, etc.)
    airflow31: pytest
    airflow31: pytest-cov
    airflow31: -e .[integration-tests]
    # Install OpenLineage for Airflow 2.x (legacy package for 2.7-2.9, provider for 2.10+)
    airflow27,airflow28,airflow29: openlineage-airflow>=1.2.0
    # Install test dependencies for Airflow 2.x (pytest, pytest-cov, etc.)
    airflow27,airflow28,airflow29,airflow210: pytest
    airflow27,airflow28,airflow29,airflow210: pytest-cov
    airflow27,airflow28,airflow29,airflow210: -e .[integration-tests]

    # For airflow210-provider: Install apache-airflow-providers-openlineage
    # instead of openlineage-airflow to test fallback logic
    # Note: We install this separately in commands_pre to override the constraint file
    # which pins version 1.13.0 (requires Airflow 3.x). We need version >=2.8.0,<3.0.0

    # Before pinning to the constraint files, we previously left the dependencies
    # more open. There were a number of packages for which this caused issues.
    # We've left those changes in here, commented out, for reference.
    ; airflow27: pydantic==2.4.2
    ; # Apparently Flask-Session 0.6.0 was released by accident.
    ; # See https://github.com/pallets-eco/flask-session/issues/209
    ; airflow24,airflow26,airflow27,airflow28: Flask-Session<0.6.0

# Install apache-airflow-providers-openlineage==2.8.0 for airflow210 and airflow210-provider
# Version 2.8.0 supports Airflow >=2.10.0, while 2.9.0+ requires Airflow 2.11.0+
# This must be done after Airflow is installed but before tests run
# We install with dependencies to get openlineage package and other required deps
# Note: The constraint file may pin a conflicting version, so we install after constraints
commands_pre =
    airflow210,airflow210-provider: uv pip install apache-airflow-providers-openlineage==2.8.0
    # Note: apache-airflow-providers-sqlite is installed in deps section above
    # We don't install it here to avoid dependency resolution issues that upgrade Airflow

commands =
    # Print installed Airflow version early for quick feedback
    python -c "import airflow; print(f'✓ Airflow version: {airflow.__version__}')"
    python -c "import sys; sys.path.insert(0, '.'); exec('try:\n    from airflow.providers.openlineage import __version__\n    print(f\"✓ OpenLineage provider version: {__version__}\")\nexcept (ImportError, ModuleNotFoundError):\n    print(\"⚠ OpenLineage provider not installed (this is OK for some test environments)\")')"
    # Run mypy type checking with version-specific stubs and exclusions
    #
    # How version-specific type checking works:
    # 1. Each tox env installs a specific Airflow version (via deps section)
    # 2. That Airflow installation provides version-specific type stubs
    # 3. We exclude the incompatible plugin implementation from checking
    #
    # Example: py311-airflow210 environment
    #   - Installs: apache-airflow~=2.10.0 (with Airflow 2.x type stubs)
    #   - Excludes: airflow3 (which uses Airflow 3.x APIs)
    #   - Checks: airflow2 with Airflow 2.10 stubs ✓
    #
    # Example: py311-airflow31 environment
    #   - Installs: apache-airflow~=3.1.0 (with Airflow 3.x type stubs)
    #   - Excludes: airflow2 (which uses Airflow 2.x APIs)
    #   - Checks: airflow3 with Airflow 3.1 stubs ✓

    # Airflow 2.x environments: Check airflow2 with Airflow 2.x stubs
    # Note: Skip mypy for airflow210-provider as it may not be installed in that environment
    # Temporarily skip mypy for all environments due to sqlmypy plugin issue - can be re-enabled later
    # airflow27,airflow28,airflow29,airflow210: mypy --exclude 'src/datahub_airflow_plugin/airflow3' src/datahub_airflow_plugin

    # Airflow 3.x environments: Check airflow3 with Airflow 3.x stubs
    # Temporarily skip mypy for airflow31 due to sqlmypy plugin issue - can be re-enabled later
    # airflow31: mypy --exclude 'src/datahub_airflow_plugin/airflow2' src/datahub_airflow_plugin

    # Run pytest with coverage
    # Use python -m pytest for all environments to ensure pytest is found
    python -m pytest --cov-append {posargs}

[testenv:py311-airflow210-provider]
# Override for airflow210-provider: Don't use constraint file as it pins
# apache-airflow-providers-openlineage==1.13.0 which requires Airflow 3.x.
# We install apache-airflow-providers-openlineage==2.8.0 separately in commands_pre.
# Explicitly set deps to override the constraint file from the base testenv.
deps =
    -e ../../metadata-ingestion/[sql-parser]
    # Pin Airflow to exact version to prevent upgrades when installing providers
    apache-airflow==2.10.5
    # Install provider packages needed for integration tests
    # Pin to 3.9.0 to match non-provider environment (from constraint file)
    # This ensures both environments use the same SQLite provider version
    # Version 3.9.0 still has SqliteOperator (deprecated but present)
    apache-airflow-providers-sqlite==3.9.0
    # Install test dependencies that are in package's dev and integration-tests extras
    # This matches how other test environments get their dependencies via install_package_deps
    # We install them explicitly here since we override deps to avoid constraint file
    pytest
    pytest-cov
    deepdiff!=8.0.0
    # Install package with integration-tests extra to get all test dependencies
    # This includes filelock and other dependencies needed for file emitter
    -e .[integration-tests]
    # No constraint file for this environment - this prevents apache-airflow-providers-openlineage==1.13.0
    # from being forced, which would require Airflow 3.x
# Override commands to skip mypy (may not be installed) and run pytest directly
commands =
    # Print installed Airflow version early for quick feedback
    python -c "import airflow; print(f'✓ Airflow version: {airflow.__version__}')"
    python -c "import sys; sys.path.insert(0, '.'); exec('try:\n    from airflow.providers.openlineage import __version__\n    print(f\"✓ OpenLineage provider version: {__version__}\")\nexcept (ImportError, ModuleNotFoundError):\n    print(\"⚠ OpenLineage provider not installed (this is OK for some test environments)\")')"
    # Run pytest with coverage (skip mypy for this environment)
    # Use python -m pytest to ensure pytest is found even if not in PATH
    python -m pytest --cov-append {posargs}
