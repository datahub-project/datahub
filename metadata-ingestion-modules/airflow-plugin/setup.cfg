[mypy]
plugins =
    sqlmypy,
    pydantic.mypy
exclude = ^(venv|build|dist)/
ignore_missing_imports = yes
strict_optional = yes
check_untyped_defs = yes
disallow_incomplete_defs = yes
disallow_untyped_decorators = yes
warn_unused_configs = yes

# Version-specific plugin modules need special handling for type checking:
#
# Architecture:
#   - airflow2: Uses Airflow 2.x APIs and standalone openlineage-airflow package
#   - airflow3: Uses Airflow 3.x APIs and native openlineage provider
#
# Type checking approach:
#   The installed Airflow package provides version-specific type stubs. Since you can't
#   install both Airflow 2.x and 3.x simultaneously, mypy must exclude the incompatible
#   plugin implementation.
#
# Local development - run mypy with exclusions based on your installed Airflow version:
#   With Airflow 2.x: mypy --exclude 'src/datahub_airflow_plugin/airflow3' src/datahub_airflow_plugin
#   With Airflow 3.x: mypy --exclude 'src/datahub_airflow_plugin/airflow2' src/datahub_airflow_plugin
#
# CI/CD - tox automatically checks both implementations with correct stubs:
#   py311-airflow210 env → installs Airflow 2.10 → checks airflow2 with Airflow 2.x stubs
#   py311-airflow31 env  → installs Airflow 3.1  → checks airflow3 with Airflow 3.x stubs

# Extractor and listener files have unavoidable type override conflicts between Airflow 2.x module paths
# The version-specific implementations work correctly at runtime, but mypy can't reconcile
# airflow.models.baseoperator.BaseOperator vs airflow.sdk.bases.operator.BaseOperator
[mypy-datahub_airflow_plugin._extractors]
ignore_errors = True

[mypy-datahub_airflow_plugin.airflow2._extractors]
ignore_errors = True

[mypy-datahub_airflow_plugin.airflow2.datahub_listener]
ignore_errors = True

# Test that imports from _extractors inherits the same type conflicts
[mypy-tests.unit.test_teradata_extractor]
ignore_errors = True

# Ignore example DAGs and integration test DAGs as they may use version-specific features
[mypy-datahub_airflow_plugin.example_dags.*]
ignore_errors = True

[mypy-tests.integration.dags.*]
ignore_errors = True
# eventually we'd like to enable these
disallow_untyped_defs = no

# try to be a bit more strict in certain areas of the codebase
[mypy-datahub.*]
ignore_missing_imports = no
[mypy-tests.*]
ignore_missing_imports = no

[tool:pytest]
asyncio_mode = auto
addopts = --strict-markers -s -v --junit-xml=test-results/junit.full.xml
junit_suite_name = ingestion-airflow-pytest
markers =
    integration: marks tests to only run in integration (deselect with '-m "not integration"')

testpaths =
    tests/unit
    tests/integration

# [coverage:run]
# # Because of some quirks in the way setup.cfg, coverage.py, pytest-cov,
# # and tox interact, we should not uncomment the following line.
# # See https://pytest-cov.readthedocs.io/en/latest/config.html and
# # https://coverage.readthedocs.io/en/coverage-5.0/config.html.
# # We also have some additional pytest/cov config options in tox.ini.
# # source = src

# [coverage:paths]
# # This is necessary for tox-based coverage to be counted properly.
# source =
#    src
#    */site-packages

[coverage:report]
show_missing = true
exclude_lines =
    pragma: no cover
    @abstract
    if TYPE_CHECKING:
omit =
    # omit example dags
    src/datahub_airflow_plugin/example_dags/*
