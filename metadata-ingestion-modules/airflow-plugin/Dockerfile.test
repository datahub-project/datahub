# Generic Dockerfile for running Airflow plugin tests via tox
# Tox handles all dependency installation including Airflow, constraints, and providers
#
# Usage:
#   docker build -f Dockerfile.test -t airflow-plugin-test .
#   docker run airflow-plugin-test [TOX_ENV] [-- PYTEST_ARGS]
#
# Examples:
#   # Run all tests with Airflow 3.1 (default)
#   docker run airflow-plugin-test
#
#   # Run tests with Airflow 2.9
#   docker run airflow-plugin-test py311-airflow29
#
#   # Run specific test with Airflow 3.1
#   docker run airflow-plugin-test py311-airflow31 -- tests/integration/test_plugin.py::test_v2_basic_dag -v
#
#   # Update golden files
#   docker run airflow-plugin-test py311-airflow31 -- --update-golden-files
#
#   # Run with different Python version (requires rebuilding image)
#   docker build -f Dockerfile.test --build-arg PYTHON_VERSION=3.10 -t airflow-plugin-test:py310 .
#   docker run airflow-plugin-test:py310 py310-airflow28

ARG PYTHON_VERSION=3.11
FROM python:${PYTHON_VERSION}-slim

# Install system dependencies required for building Python packages
# Also install gosu for switching users (Airflow 3.x requirement)
RUN apt-get update && apt-get install -y \
    git \
    build-essential \
    libpq-dev \
    curl \
    gosu \
    && rm -rf /var/lib/apt/lists/*

# Set initial working directory
WORKDIR /app

# Copy the entire repository context (needed for tox to install ../../metadata-ingestion)
# Note: This expects to be run from the repository root with -f metadata-ingestion-modules/airflow-plugin/Dockerfile.test
COPY . /app/

# Change to the airflow-plugin directory where tox.ini is located
WORKDIR /app/metadata-ingestion-modules/airflow-plugin

# Install tox and uv (tox uses uv for faster installations)
RUN pip install --no-cache-dir tox uv

# Set default tox environment
ENV TOX_ENV=py311-airflow31

# Set UV cache directory to /tmp (writable by all users)
ENV UV_CACHE_DIR=/tmp/.uv-cache

# Create entrypoint script that handles user creation for Airflow 3.x
# This script runs as root, creates a user matching the host UID/GID, then switches to that user
RUN echo '#!/bin/bash\n\
set -e\n\
\n\
# Airflow 3.x requires a real user with username and home directory\n\
# If USER_ID and GROUP_ID are provided via environment, create that user\n\
if [ -n "$USER_ID" ] && [ -n "$GROUP_ID" ]; then\n\
  echo "[Entrypoint] Creating testuser with UID=$USER_ID GID=$GROUP_ID"\n\
  \n\
  # Create group if it does not exist\n\
  if ! getent group $GROUP_ID > /dev/null 2>&1; then\n\
    groupadd -g $GROUP_ID testgroup\n\
  fi\n\
  \n\
  # Create user with the specified UID/GID\n\
  if ! id testuser > /dev/null 2>&1; then\n\
    useradd -u $USER_ID -g $GROUP_ID -d /tmp -s /bin/bash testuser\n\
  fi\n\
  \n\
  # Run tox as the created user using gosu\n\
  if [ $# -eq 0 ]; then\n\
    exec gosu testuser tox -e "$TOX_ENV"\n\
  elif [[ "$1" == py* ]]; then\n\
    exec gosu testuser tox -e "$@"\n\
  else\n\
    exec gosu testuser tox -e "$TOX_ENV" -- "$@"\n\
  fi\n\
else\n\
  # No USER_ID/GROUP_ID provided, run as root (or current user)\n\
  if [ $# -eq 0 ]; then\n\
    exec tox -e "$TOX_ENV"\n\
  elif [[ "$1" == py* ]]; then\n\
    exec tox -e "$@"\n\
  else\n\
    exec tox -e "$TOX_ENV" -- "$@"\n\
  fi\n\
fi' > /entrypoint.sh && chmod +x /entrypoint.sh

# Default command: run tox with the default environment
ENTRYPOINT ["/entrypoint.sh"]